
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Rails · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="../rack/rack-webrik.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    iOS 开发
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../../ObjC-Basic/">
            
                <a href="../../ObjC-Basic/">
            
                    
                    Objective-C 语言基础
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.1" data-path="../../ObjC-Basic/Class.html">
            
                <a href="../../ObjC-Basic/Class.html">
            
                    
                    类与对象
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.2" data-path="../../ObjC-Basic/Block.html">
            
                <a href="../../ObjC-Basic/Block.html">
            
                    
                    Block 编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.3" data-path="../../ObjC-Basic/Runtime.html">
            
                <a href="../../ObjC-Basic/Runtime.html">
            
                    
                    Objective-C Runtime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.4" data-path="../../ObjC-Basic/MM.html">
            
                <a href="../../ObjC-Basic/MM.html">
            
                    
                    Objective-C 内存管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.5" data-path="../../ObjC-Basic/Runloop.html">
            
                <a href="../../ObjC-Basic/Runloop.html">
            
                    
                    Runloop
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="../../Cocoa-Touch/">
            
                <a href="../../Cocoa-Touch/">
            
                    
                    Cocoa Touch
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.2.1" data-path="../../Cocoa-Touch/Event-Handling.html">
            
                <a href="../../Cocoa-Touch/Event-Handling.html">
            
                    
                    事件处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.2" data-path="../../Cocoa-Touch/UIApplication.html">
            
                <a href="../../Cocoa-Touch/UIApplication.html">
            
                    
                    UIApplication
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.3" data-path="../../Cocoa-Touch/UIView-Basic.html">
            
                <a href="../../Cocoa-Touch/UIView-Basic.html">
            
                    
                    UIView
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.4" data-path="../../Cocoa-Touch/UIViewController.html">
            
                <a href="../../Cocoa-Touch/UIViewController.html">
            
                    
                    UIViewController
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.5" data-path="../../Cocoa-Touch/Animation.html">
            
                <a href="../../Cocoa-Touch/Animation.html">
            
                    
                    动画
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.6" data-path="../../Cocoa-Touch/Network.html">
            
                <a href="../../Cocoa-Touch/Network.html">
            
                    
                    网络编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.7" data-path="../../Cocoa-Touch/Multithreading.html">
            
                <a href="../../Cocoa-Touch/Multithreading.html">
            
                    
                    并发编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.8" data-path="../../Cocoa-Touch/File-System.html">
            
                <a href="../../Cocoa-Touch/File-System.html">
            
                    
                    文件系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.9" data-path="../../Cocoa-Touch/Design.html">
            
                <a href="../../Cocoa-Touch/Design.html">
            
                    
                    设计模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.10" data-path="../../Cocoa-Touch/Performance.html">
            
                <a href="../../Cocoa-Touch/Performance.html">
            
                    
                    性能
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="../../Swift/">
            
                <a href="../../Swift/">
            
                    
                    Swift
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.3.1" data-path="../../Swift/Class.html">
            
                <a href="../../Swift/Class.html">
            
                    
                    类与对象
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.2" data-path="../../Swift/Struct-And-Enum.html">
            
                <a href="../../Swift/Struct-And-Enum.html">
            
                    
                    结构体与枚举
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.3" data-path="../../Swift/Function-And-Closure.html">
            
                <a href="../../Swift/Function-And-Closure.html">
            
                    
                    函数与闭包
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="../../Interview/">
            
                <a href="../../Interview/">
            
                    
                    面试问题
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.4.1" data-path="../../Interview/iOSInterviewQuestions/">
            
                <a href="../../Interview/iOSInterviewQuestions/">
            
                    
                    《招聘一个靠谱的iOS》
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.4.1.1" data-path="../../Interview/iOSInterviewQuestions/Volume-One/volume-one.html">
            
                <a href="../../Interview/iOSInterviewQuestions/Volume-One/volume-one.html">
            
                    
                    《招聘一个靠谱的iOS》(上)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.1.2" data-path="../../Interview/iOSInterviewQuestions/Volume-Two/volume-two.html">
            
                <a href="../../Interview/iOSInterviewQuestions/Volume-Two/volume-two.html">
            
                    
                    《招聘一个靠谱的iOS》(下)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.4.2" data-path="../../interview/ZhiHu-QA/">
            
                <a href="../../interview/ZhiHu-QA/">
            
                    
                    关于一些 iOS 面试问题的解答
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.3" data-path="../../interview/iOSDeveloperQA/">
            
                <a href="../../interview/iOSDeveloperQA/">
            
                    
                    iOS 开发面试问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.4" data-path="../../interview/MXR-QA/">
            
                <a href="../../interview/MXR-QA/">
            
                    
                    MXR 面试问题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="../">
            
                <a href="../">
            
                    
                    源码分析
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.1" data-path="../AFNetworking/AFNetworking_1.html">
            
                <a href="../AFNetworking/AFNetworking_1.html">
            
                    
                    AFNetworking
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.1.1" data-path="../AFNetworking/AFNetworking_2.html">
            
                <a href="../AFNetworking/AFNetworking_2.html">
            
                    
                    AFURLSessionManager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.1.2" data-path="../AFNetworking/AFNetworking_3.html">
            
                <a href="../AFNetworking/AFNetworking_3.html">
            
                    
                    AFURLSerialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.1.3" data-path="../AFNetworking/AFNetworking_4.html">
            
                <a href="../AFNetworking/AFNetworking_4.html">
            
                    
                    AFNetworkReachabilityManager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.1.4" data-path="../AFNetworking/AFNetworking_5.html">
            
                <a href="../AFNetworking/AFNetworking_5.html">
            
                    
                    HTTPS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.2" data-path="../Alamofire/">
            
                <a href="../Alamofire/">
            
                    
                    Alamofire
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.3" data-path="../architecture/mvx.html">
            
                <a href="../architecture/mvx.html">
            
                    
                    architecture
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.3.1" data-path="../architecture/mvx-model.html">
            
                <a href="../architecture/mvx-model.html">
            
                    
                    MVX-Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.3.2" data-path="../architecture/mvx-view.html">
            
                <a href="../architecture/mvx-view.html">
            
                    
                    MVX-View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.3.3" data-path="../architecture/mvx-controller.html">
            
                <a href="../architecture/mvx-controller.html">
            
                    
                    MVX-Controller
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.4" >
            
                <span>
            
                    
                    AsyncDisplayKit
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.4.1" data-path="../AsyncDisplayKit/ASDK_1.html">
            
                <a href="../AsyncDisplayKit/ASDK_1.html">
            
                    
                    提升界面的渲染性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.4.2" data-path="../AsyncDisplayKit/ASDK_2.html">
            
                <a href="../AsyncDisplayKit/ASDK_2.html">
            
                    
                    布局算法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.4.3" data-path="../AsyncDisplayKit/ASDK_3.html">
            
                <a href="../AsyncDisplayKit/ASDK_3.html">
            
                    
                    预加载与智能预加载
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.5" >
            
                <span>
            
                    
                    BlocksKit
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.5.1" data-path="../BlocksKit/BlocksKit_1.html">
            
                <a href="../BlocksKit/BlocksKit_1.html">
            
                    
                    神奇的 BlocksKit (一)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.5.2" data-path="../BlocksKit/BlocksKit_2.html">
            
                <a href="../BlocksKit/BlocksKit_2.html">
            
                    
                    神奇的 BlocksKit (二)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.6" data-path="../Blog/initialize-comments.html">
            
                <a href="../Blog/initialize-comments.html">
            
                    
                    Gitalk/Gitment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.7" >
            
                <span>
            
                    
                    CocoaPods
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.7.1" data-path="../CocoaPods/CocoaPods.html">
            
                <a href="../CocoaPods/CocoaPods.html">
            
                    
                    CocoaPods 都做了什么
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.7.2" data-path="../CocoaPods/DSL.html">
            
                <a href="../CocoaPods/DSL.html">
            
                    
                    DSL 以及 DSL 的应用
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.8" >
            
                <span>
            
                    
                    Database
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.8.1" data-path="../Database/concurrency-control.html">
            
                <a href="../Database/concurrency-control.html">
            
                    
                    数据库并发控制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.2" data-path="../Database/dynamo.html">
            
                <a href="../Database/dynamo.html">
            
                    
                    分布式键值存储 Dynamo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.3" data-path="../Database/leveldb-bigtable.html">
            
                <a href="../Database/leveldb-bigtable.html">
            
                    
                    Bigtable 和 LevelDB 的实现
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.4" data-path="../Database/mongodb-to-mysql.html">
            
                <a href="../Database/mongodb-to-mysql.html">
            
                    
                    MongoDB 迁移到 MySQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.5" data-path="../Database/mongodb-wiredtiger.html">
            
                <a href="../Database/mongodb-wiredtiger.html">
            
                    
                    MongoDB 和 WiredTiger
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.6" data-path="../Database/mysql.html">
            
                <a href="../Database/mysql.html">
            
                    
                    MySQL 和 InnoDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.7" data-path="../Database/sql-index-intro.html">
            
                <a href="../Database/sql-index-intro.html">
            
                    
                    MySQL 索引设计概要
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.8" data-path="../Database/sql-index-performance.html">
            
                <a href="../Database/sql-index-performance.html">
            
                    
                    MySQL 索引性能分析概要
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.8.9" data-path="../Database/transaction.html">
            
                <a href="../Database/transaction.html">
            
                    
                    MySQL 中事务的实现
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.9" data-path="../DKNightVersion/DKNightVersion.html">
            
                <a href="../DKNightVersion/DKNightVersion.html">
            
                    
                    DKNightVersion
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.10" >
            
                <span>
            
                    
                    FBRetainCycleDetector
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.10.1" data-path="../FBRetainCycleDetector/block.html">
            
                <a href="../FBRetainCycleDetector/block.html">
            
                    
                    block 如何持有对象
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.10.2" data-path="../FBRetainCycleDetector/Obj-Associated.html">
            
                <a href="../FBRetainCycleDetector/Obj-Associated.html">
            
                    
                    Associated Object
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.10.3" data-path="../FBRetainCycleDetector/Obj-Strong.html">
            
                <a href="../FBRetainCycleDetector/Obj-Strong.html">
            
                    
                    对象持有的强指针
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.10.4" data-path="../FBRetainCycleDetector/retain_cycle.html">
            
                <a href="../FBRetainCycleDetector/retain_cycle.html">
            
                    
                    解决循环引用
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.11" data-path="../fishhook/fishhook.html">
            
                <a href="../fishhook/fishhook.html">
            
                    
                    fishhook
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.12" data-path="../IQKeyboardManager/IQKeyboardManager.html">
            
                <a href="../IQKeyboardManager/IQKeyboardManager.html">
            
                    
                    IQKeyboardManager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.13" data-path="../KVOController/KVOController.html">
            
                <a href="../KVOController/KVOController.html">
            
                    
                    KVOController
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.14" data-path="../libextobjc/libextobjc.html">
            
                <a href="../libextobjc/libextobjc.html">
            
                    
                    libextobjc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.15" data-path="../Masonry/Masonry.html">
            
                <a href="../Masonry/Masonry.html">
            
                    
                    Masonry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.16" data-path="../MBProgressHUD/">
            
                <a href="../MBProgressHUD/">
            
                    
                    MBProgressHUD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17" data-path="../objc/">
            
                <a href="../objc/">
            
                    
                    objc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.17.1" data-path="../objc/associated-obj.html">
            
                <a href="../objc/associated-obj.html">
            
                    
                    关联对象 AssociatedObject
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.2" data-path="../objc/autoreleasepool.html">
            
                <a href="../objc/autoreleasepool.html">
            
                    
                    自动释放池
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.3" data-path="../objc/black-box-retain-release.html">
            
                <a href="../objc/black-box-retain-release.html">
            
                    
                    黑箱中的 retain 和 release
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.4" data-path="../objc/func-structure.html">
            
                <a href="../objc/func-structure.html">
            
                    
                    ObjC 中方法的结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.5" data-path="../objc/hash.html">
            
                <a href="../objc/hash.html">
            
                    
                    哈希表的实现
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.6" data-path="../objc/initialization.html">
            
                <a href="../objc/initialization.html">
            
                    
                    初始化对象
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.7" data-path="../objc/isa.html">
            
                <a href="../objc/isa.html">
            
                    
                    isa
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.8" data-path="../objc/lazy-initialize.html">
            
                <a href="../objc/lazy-initialize.html">
            
                    
                    懒惰的 initialize 方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.9" data-path="../objc/load.html">
            
                <a href="../objc/load.html">
            
                    
                    load 方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.17.10" data-path="../objc/msgSend.html">
            
                <a href="../objc/msgSend.html">
            
                    
                    消息传递
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.18" >
            
                <span>
            
                    
                    OHHTTPStubs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.18.1" data-path="../OHHTTPStubs/intercept.html">
            
                <a href="../OHHTTPStubs/intercept.html">
            
                    
                    HTTP Intercept
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.18.2" data-path="../OHHTTPStubs/mock.html">
            
                <a href="../OHHTTPStubs/mock.html">
            
                    
                    HTTP Mock
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.19" data-path="../ProtocolKit/ProtocolKit.html">
            
                <a href="../ProtocolKit/ProtocolKit.html">
            
                    
                    ProtocolKit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.20" data-path="../rack/rack.html">
            
                <a href="../rack/rack.html">
            
                    
                    rack
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.20.1" data-path="../rack/rack-thin.html">
            
                <a href="../rack/rack-thin.html">
            
                    
                    Thin 的事件驱动模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.20.2" data-path="../rack/rack-unicorn.html">
            
                <a href="../rack/rack-unicorn.html">
            
                    
                    Unicorn 的多进程模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.20.3" data-path="../rack/rack-webrik.html">
            
                <a href="../rack/rack-webrik.html">
            
                    
                    WEBrick 的实现
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.1.5.21" data-path="activerecord.html">
            
                <a href="activerecord.html">
            
                    
                    Rails
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22" >
            
                <span>
            
                    
                    ReactiveObjC
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.22.1" data-path="../ReactiveObjC/RACChannel.html">
            
                <a href="../ReactiveObjC/RACChannel.html">
            
                    
                    RACChannel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22.2" data-path="../ReactiveObjC/RACCommand.html">
            
                <a href="../ReactiveObjC/RACCommand.html">
            
                    
                    RACCommand
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22.3" data-path="../ReactiveObjC/RACDelegateProxy.html">
            
                <a href="../ReactiveObjC/RACDelegateProxy.html">
            
                    
                    RACDelegateProxy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22.4" data-path="../ReactiveObjC/RACMulticastConnection.html">
            
                <a href="../ReactiveObjC/RACMulticastConnection.html">
            
                    
                    RACMulticastConnection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22.5" data-path="../ReactiveObjC/RACScheduler.html">
            
                <a href="../ReactiveObjC/RACScheduler.html">
            
                    
                    RACScheduler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22.6" data-path="../ReactiveObjC/RACSequence.html">
            
                <a href="../ReactiveObjC/RACSequence.html">
            
                    
                    RACSequence
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22.7" data-path="../ReactiveObjC/RACSignal.html">
            
                <a href="../ReactiveObjC/RACSignal.html">
            
                    
                    RACSignal
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.22.8" data-path="../ReactiveObjC/RACSubject.html">
            
                <a href="../ReactiveObjC/RACSubject.html">
            
                    
                    RACSubject
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.23" >
            
                <span>
            
                    
                    Redis
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.23.1" data-path="../Redis/redis-cli.html">
            
                <a href="../Redis/redis-cli.html">
            
                    
                    命令处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.23.2" data-path="../Redis/redis-eventloop.html">
            
                <a href="../Redis/redis-eventloop.html">
            
                    
                    事件循环
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.23.3" data-path="../Redis/redis-io-multiplexing.html">
            
                <a href="../Redis/redis-io-multiplexing.html">
            
                    
                    I/O 多路复用
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5.24" data-path="../Ruby/Ruby.html">
            
                <a href="../Ruby/Ruby.html">
            
                    
                    Ruby
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.25" data-path="../SDWebImage/">
            
                <a href="../SDWebImage/">
            
                    
                    SDWebImage
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="../../More.html">
            
                <a href="../../More.html">
            
                    
                    更多资料
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Rails</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x5168;&#x9762;&#x7406;&#x89E3;-activerecord">&#x5168;&#x9762;&#x7406;&#x89E3; ActiveRecord</h1>
<p>&#x6700;&#x8FD1;&#x4E8B;&#x60C5;&#x5E76;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x591A;&#xFF0C;&#x770B;&#x4E86;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x5E93;&#x76F8;&#x5173;&#x7684;&#x4E66;&#x7C4D;&#xFF0C;&#x6700;&#x540E;&#x60F3;&#x5230;&#x81EA;&#x5DF1;&#x5E76;&#x4E0D;&#x4E86;&#x89E3;&#x6BCF;&#x5929;&#x90FD;&#x5728;&#x7528;&#x7684; ActiveRecord&#xFF0C;&#x5BF9;&#x4E8E;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x6A21;&#x578B;&#x3001;&#x5EFA;&#x7ACB;&#x5173;&#x7CFB;&#x3001;&#x6267;&#x884C; SQL &#x67E5;&#x8BE2;&#x4EE5;&#x53CA;&#x5B8C;&#x6210;&#x6570;&#x636E;&#x5E93;&#x8FC1;&#x79FB;&#x7684;&#xFF0C;&#x4F5C;&#x8005;&#x4E00;&#x76F4;&#x90FD;&#x6709;&#x7740;&#x81EA;&#x5DF1;&#x7684;&#x731C;&#x6D4B;&#xFF0C;&#x4F46;&#x662F;&#x771F;&#x6B63;&#x5230;&#x6E90;&#x4EE3;&#x7801;&#x4E2D;&#x53BB;&#x5BFB;&#x627E;&#x7B54;&#x6848;&#x4E00;&#x76F4;&#x90FD;&#x662F;&#x6CA1;&#x6709;&#x505A;&#x8FC7;&#x7684;&#x3002;</p>
<p><img src="images/activerecord/activerecord-architecture.png" alt="activerecord-architecture"></p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06; ActiveRecord &#x7406;&#x89E3;&#x4E3A;&#x4E00;&#x4E2A;&#x4E0D;&#x540C; SQL &#x6570;&#x636E;&#x5E93;&#x7684; Wrapper&#xFF0C;&#x540C;&#x65F6;&#x4E3A;&#x4E0A;&#x5C42;&#x63D0;&#x4F9B;&#x4E00;&#x79CD;&#x7B80;&#x6D01;&#x3001;&#x4F18;&#x96C5;&#x7684; API &#x6216;&#x8005;&#x8BF4; DSL&#xFF0C;&#x80FD;&#x591F;&#x6781;&#x5927;&#x5F97;&#x51CF;&#x8F7B;&#x5F00;&#x53D1;&#x8005;&#x7684;&#x8D1F;&#x62C5;&#x5E76;&#x63D0;&#x5347;&#x5DE5;&#x4F5C;&#x6548;&#x7387;&#x3002;</p>
<p>&#x6587;&#x7AE0;&#x5206;&#x56DB;&#x4E2A;&#x90E8;&#x5206;&#x4ECB;&#x7ECD;&#x4E86; ActiveRecord &#x4E2D;&#x7684;&#x91CD;&#x8981;&#x5185;&#x5BB9;&#xFF0C;&#x6A21;&#x578B;&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x3001;Scope &#x548C;&#x67E5;&#x8BE2;&#x7684;&#x5B9E;&#x73B0;&#x3001;&#x6A21;&#x578B;&#x5173;&#x7CFB;&#x7684;&#x5B9E;&#x73B0;&#x4EE5;&#x53CA;&#x6700;&#x540E;&#x7684; Migrations &#x4EFB;&#x52A1;&#x7684;&#x5B9E;&#x73B0;&#x548C;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#xFF0C;&#x5404;&#x4E2A;&#x6A21;&#x5757;&#x4E4B;&#x95F4;&#x6CA1;&#x6709;&#x592A;&#x591A;&#x7684;&#x5173;&#x8054;&#xFF0C;&#x7531;&#x4E8E;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x5982;&#x679C;&#x8BFB;&#x8005;&#x53EA;&#x5BF9;&#x67D0;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x5185;&#x5BB9;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x53EF;&#x4EE5;&#x53EA;&#x6311;&#x9009;&#x4E00;&#x90E8;&#x5206;&#x8FDB;&#x884C;&#x9605;&#x8BFB;&#x3002;</p>
<h2 id="&#x6A21;&#x578B;&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;">&#x6A21;&#x578B;&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;</h2>
<p>&#x5728;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5148;&#x5206;&#x6790;&#x9605;&#x8BFB; ActiveRecord &#x662F;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x6A21;&#x578B;&#x5E76;&#x5C06;&#x6570;&#x636E;&#x63D2;&#x5165;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#xFF0C;&#x7531;&#x4E8E; ActiveRecord &#x7684;&#x6E90;&#x7801;&#x53D8;&#x66F4;&#x975E;&#x5E38;&#x8FC5;&#x901F;&#xFF0C;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x7684; ActiveRecord &#x7248;&#x672C;&#x662F; v5.1.4&#xFF0C;&#x5982;&#x679C;&#x5E0C;&#x671B;&#x91CD;&#x73B0;&#x6587;&#x4E2D;&#x5BF9;&#x65B9;&#x6CD5;&#x7684;&#x8FFD;&#x8E2A;&#x8FC7;&#x7A0B;&#x53EF;&#x4EE5; checkout &#x5230; v5.1.4 &#x7684;&#x6807;&#x7B7E;&#x4E0A;&#x5E76;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x7684;&#x547D;&#x4EE4;&#x5B89;&#x88C5;&#x6307;&#x5B9A;&#x7248;&#x672C;&#x7684; ActiveRecord&#xFF1A;</p>
<pre><code class="lang-shell">$ gem install activerecord -v &apos;5.1.4&apos;
</code></pre>
<h3 id="&#x5F15;&#x5165;-activerecord">&#x5F15;&#x5165; ActiveRecord</h3>
<p>&#x5728;&#x6B63;&#x5F0F;&#x5F00;&#x59CB;&#x4F7F;&#x7528; <a href="https://github.com/pry/pry" target="_blank">pry</a> &#x5BF9;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x8FFD;&#x8E2A;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x73B0;&#x5728; pry &#x4E2D; <code>require</code> &#x5BF9;&#x5E94;&#x7684; gem&#xFF0C;&#x5E76;&#x4E14;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x8FFD;&#x8E2A;&#x7684;&#x6A21;&#x578B;&#x7C7B;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; <span class="hljs-keyword">require</span> <span class="hljs-string">&apos;active_record&apos;</span>
=&gt; true
pry(main)&gt; <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> &lt; ActiveRecord::Base;</span> <span class="hljs-keyword">end</span>
=&gt; nil
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x6B65;&#x9AA4;&#x975E;&#x5E38;&#x7684;&#x7B80;&#x5355;&#xFF0C;&#x8FD9;&#x91CC;&#x4E5F;&#x4E0D;&#x591A;&#x8BF4;&#x4EC0;&#x4E48;&#x4E86;&#xFF0C;&#x53EA;&#x662F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x7EE7;&#x627F;&#x81EA; <code>ActiveRecord::Base</code> &#x7684;&#x7C7B; <code>Post</code>&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x5E76;&#x6CA1;&#x6709;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x7684;&#x8868;&#x7ED3;&#x6784;&#xFF0C;&#x4E0D;&#x8FC7;&#x76EE;&#x524D;&#x6765;&#x8BF4;&#x5DF2;&#x7ECF;&#x591F;&#x7528;&#x4E86;&#x3002;</p>
<h3 id="&#x4ECE;-postcreate-&#x5F00;&#x59CB;">&#x4ECE; Post.create &#x5F00;&#x59CB;</h3>
<p>&#x4F7F;&#x7528;&#x8FC7; ActiveRecord &#x7684;&#x4EBA;&#x90FD;&#x77E5;&#x9053;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x4F7F;&#x7528; <code>Post.create</code> &#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x6761;&#x6570;&#x636E;&#x8BB0;&#x5F55;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C31;&#x5C06;&#x8BE5;&#x65B9;&#x6CD5;&#x4F5C;&#x4E3A;&#x5165;&#x53E3;&#x4E00;&#x63A2;&#x7A76;&#x7ADF;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; $ Post.create

<span class="hljs-symbol">From:</span> lib/active_record/persistence.rb @ line <span class="hljs-number">29</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Persistence</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:ClassMethods</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span><span class="hljs-params">(attributes = <span class="hljs-keyword">nil</span>, &amp;block)</span></span>
  <span class="hljs-keyword">if</span> attributes.is_a?(Array)
    attributes.collect { |attr| create(attr, &amp;block) }
  <span class="hljs-keyword">else</span>
    object = new(attributes, &amp;block)
    object.save
    object
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<blockquote>
<p><code>$</code> &#x662F; pry &#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x7684;&#x7528;&#x4E8E;&#x67E5;&#x770B;&#x65B9;&#x6CD5;&#x6E90;&#x4EE3;&#x7801;&#x7684;&#x5DE5;&#x5177;&#xFF0C;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#x4F1A;&#x7701;&#x7565; <code>$</code> &#x65B9;&#x6CD5;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x8F93;&#x51FA;&#xFF0C;&#x8FD8;&#x53EF;&#x80FD;&#x4F1A;&#x5BF9;&#x65B9;&#x6CD5;&#x505A;&#x4E00;&#x4E9B;&#x7B80;&#x5316;&#x51CF;&#x5C11;&#x7406;&#x89E3;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;&#x65F6;&#x7684;&#x5E72;&#x6270;&#x3002;</p>
</blockquote>
<p>&#x901A;&#x8FC7; pry &#x7684;&#x8F93;&#x51FA;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; ActiveRecord &#x7684; <code>lib/active_record/persistence.rb</code> &#x6587;&#x4EF6;&#x4E2D;&#x627E;&#x5230; <code>ActiveRecord::Base.create</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A; <code>Hash</code>&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x4F1A;&#x5148;&#x540E;&#x6267;&#x884C; <code>ActiveRecord::Base.new</code> &#x548C; <code>ActiveRecord::Base#save!</code> &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5BF9;&#x8C61;&#x5E76;&#x4FDD;&#x5B58;&#x3002;</p>
<h4 id="&#x4F7F;&#x7528;-pry-&#x8FFD;&#x8E2A;-save">&#x4F7F;&#x7528; pry &#x8FFD;&#x8E2A; #save!</h4>
<p><code>ActiveRecord::Base.new</code> &#x5728;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#x90FD;&#x4F1A;&#x8C03;&#x7528;&#x7236;&#x7C7B;&#x7684; <code>#initialize</code> &#x65B9;&#x6CD5;&#x521D;&#x59CB;&#x5316;&#x5B9E;&#x4F8B;&#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x597D;&#x8BF4;&#x7684;&#xFF0C;&#x800C; <code>ActiveRecord::Base#save!</code> &#x65B9;&#x6CD5;&#x5C31;&#x505A;&#x4E86;&#x5F88;&#x591A;&#x4E8B;&#x60C5;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; $ <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Base</span><span class="hljs-comment">#save!</span>

<span class="hljs-symbol">From:</span> lib/active_record/suppressor.rb @ line <span class="hljs-number">45</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Suppressor</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save!</span><span class="hljs-params">(*)</span></span> <span class="hljs-comment"># :nodoc:</span>
  SuppressorRegistry.suppressed[<span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span>.name] ? <span class="hljs-keyword">true</span> <span class="hljs-symbol">:</span> <span class="hljs-keyword">super</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x9996;&#x5148;&#x662F;&#x4F7F;&#x7528; <code>SuppressorRegistry</code> &#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x5BF9;&#x5F53;&#x524D;&#x7684;&#x5B58;&#x53D6;&#x8BF7;&#x6C42;&#x8FDB;&#x884C;&#x6291;&#x5236;&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C; <code>super</code> &#x65B9;&#x6CD5;&#xFF0C;&#x7531;&#x4E8E;&#x4ECE;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x4E2D;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x77E5;&#x9053;&#x8FD9;&#x91CC;&#x7684; <code>super</code> &#x5230;&#x5E95;&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x901A;&#x8FC7; <code>.ancestors</code> &#x65B9;&#x6CD5;&#x770B;&#x770B; <code>ActiveRecord::Base</code> &#x5230;&#x5E95;&#x6709;&#x54EA;&#x4E9B;&#x7236;&#x7C7B;&#x4E86;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Base</span>.ancestors
=&gt; [<span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Base</span>,
 <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Suppressor</span>,
 ...
 <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Persistence</span>,
 <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Core</span>,
 <span class="hljs-symbol">ActiveSupport:</span><span class="hljs-symbol">:ToJsonWithActiveSupportEncoder</span>,
 Object,
 ...
 Kernel,
 BasicObject]

pry(main)&gt; <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Base</span>.ancestors.count
=&gt; <span class="hljs-number">65</span>
</code></pre>
<p>&#x4F7F;&#x7528; <code>.ancestors</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4F60;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6574;&#x4E2A;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x94FE;&#x4E0A;&#x5305;&#x542B; 64 &#x4E2A;&#x7236;&#x7C7B;&#xFF0C;&#x5728;&#x8FD9;&#x65F6;&#x7B80;&#x5355;&#x7684;&#x4F7F;&#x7528; pry &#x5C31;&#x5DF2;&#x7ECF;&#x4E0D;&#x80FD;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x7406;&#x89E3;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A; pry &#x6CA1;&#x6CD5;&#x67E5;&#x770B;&#x5F53;&#x524D;&#x7684;&#x65B9;&#x6CD5;&#x5728;&#x7236;&#x7C7B;&#x4E2D;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4ECE;&#x5DE5;&#x7A0B;&#x4E2D;&#x5206;&#x6790;&#x54EA;&#x4E9B;&#x7C7B;&#x7684; <code>#save!</code> &#x65B9;&#x6CD5;&#x5728;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#x88AB;&#x6267;&#x884C;&#x4E86;&#x5E76;&#x6839;&#x636E;&#x4E0A;&#x8FF0;&#x5217;&#x8868;&#x6392;&#x51FA;&#x5B83;&#x4EEC;&#x6267;&#x884C;&#x7684;&#x987A;&#x5E8F;&#xFF1B;&#x7ECF;&#x8FC7;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x5982;&#x4E0B;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</p>
<p><img src="images/activerecord/activerecord-base-save.png" alt="activerecord-base-save"></p>
<p>&#x4ECE; <code>ActiveRecord::Suppressor</code> &#x5230; <code>ActiveRecord::Persistence</code> &#x4E00;&#x5171;&#x6709;&#x4E94;&#x4E2A; module &#x5B9E;&#x73B0;&#x4E86; <code>#save!</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;&#x4E86; <code>ActiveRecord::Suppressor#save!</code> &#x6A21;&#x5757;&#x63D0;&#x4F9B;&#x4E86;&#x5BF9;&#x4FDD;&#x5B58;&#x7684;&#x6291;&#x5236;&#x529F;&#x80FD;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C06;&#x4F9D;&#x6B21;&#x770B;&#x540E;&#x56DB;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x5728;&#x4FDD;&#x5B58;&#x6A21;&#x578B;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#x3002;</p>
<h4 id="&#x4E8B;&#x52A1;&#x7684;&#x6267;&#x884C;">&#x4E8B;&#x52A1;&#x7684;&#x6267;&#x884C;</h4>
<p>&#x4ECE;&#x540D;&#x5B57;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x51FA; <code>ActiveRecord::Transactions</code> &#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x63D0;&#x4F9B;&#x652F;&#x6301;&#xFF0C;&#x5E76;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x7684;&#x4E0D;&#x540C;&#x9636;&#x6BB5;&#x6267;&#x884C;&#x4E0D;&#x540C;&#x7684;&#x56DE;&#x8C03;&#xFF0C;&#x8FD9;&#x4E2A; module &#x4E2D;&#x7684; <code>#save!</code> &#x65B9;&#x6CD5;&#x4EC5;&#x5728; <code>#with_transaction_returning_status</code> &#x7684; block &#x4E2D;&#x6267;&#x884C;&#x4E86; <code>super</code>&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ActiveRecord</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Transactions</span></span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save!</span><span class="hljs-params">(*)</span></span> <span class="hljs-comment">#:nodoc:</span>
      with_transaction_returning_status { <span class="hljs-keyword">super</span> }
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>#with_transaction_returning_status</code> &#x65B9;&#x6CD5;&#x4F1A;&#x8FD0;&#x884C;&#x5916;&#x90E8;&#x4F20;&#x5165;&#x7684; block &#x901A;&#x8FC7; <code>super</code> &#x6267;&#x884C;&#x7236;&#x7C7B;&#x7684; <code>#save!</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">with_transaction_returning_status</span></span>
  status = <span class="hljs-keyword">nil</span>
  <span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span>.transaction <span class="hljs-keyword">do</span>
    add_to_transaction
    <span class="hljs-keyword">begin</span>
      status = <span class="hljs-keyword">yield</span>
    <span class="hljs-keyword">rescue</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Rollback</span>
      clear_transaction_record_state
      status = <span class="hljs-keyword">nil</span>
    <span class="hljs-keyword">end</span>

    raise <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Rollback</span> <span class="hljs-keyword">unless</span> status
  <span class="hljs-keyword">end</span>
  status
<span class="hljs-keyword">ensure</span>
  <span class="hljs-keyword">if</span> @transaction_state &amp;&amp; @transaction_state.committed?
    clear_transaction_record_state
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x8FF0;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x6240;&#x6709;&#x7684; SQL &#x8BF7;&#x6C42;&#x90FD;&#x5305;&#x88C5;&#x5728;&#x4E86;&#x4E00;&#x4E2A; <code>.transaction</code> &#x4E2D;&#xFF0C;&#x5F00;&#x542F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x5E76;&#x5728;&#x5176;&#x4E2D;&#x6267;&#x884C;&#x8BF7;&#x6C42;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x7EDF;&#x4E00;&#x5904;&#x7406;&#x4E00;&#x4E9B;&#x8DDF;&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;&#x4EE5;&#x53CA;&#x5F02;&#x5E38;&#x76F8;&#x5173;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x540C;&#x65F6; <code>ActiveRecord::Transactions</code> &#x53C8;&#x80FD;&#x4E3A;&#x5F53;&#x524D;&#x7684;&#x6A21;&#x578B;&#x6DFB;&#x52A0;&#x4E00;&#x4E9B;&#x56DE;&#x8C03;&#x7684;&#x652F;&#x6301;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ActiveRecord</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Transactions</span></span>
    included <span class="hljs-keyword">do</span>
      define_callbacks <span class="hljs-symbol">:commit</span>, <span class="hljs-symbol">:rollback</span>,
                       <span class="hljs-symbol">:before_commit</span>,
                       <span class="hljs-symbol">:before_commit_without_transaction_enrollment</span>,
                       <span class="hljs-symbol">:commit_without_transaction_enrollment</span>,
                       <span class="hljs-symbol">:rollback_without_transaction_enrollment</span>,
                       <span class="hljs-symbol">scope:</span> [<span class="hljs-symbol">:kind</span>, <span class="hljs-symbol">:name</span>]
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5F00;&#x53D1;&#x8005;&#x5C31;&#x80FD;&#x591F;&#x5728;&#x6A21;&#x578B;&#x4E2D;&#x6839;&#x636E;&#x9700;&#x8981;&#x6CE8;&#x518C;&#x56DE;&#x8C03;&#x7528;&#x6765;&#x76D1;&#x542C;&#x5404;&#x79CD;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x76F8;&#x5173;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x7EDD;&#x5927;&#x591A;&#x6570;&#x7684;&#x4E8B;&#x52A1;&#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x5728; <code>ActiveRecord::ConnectionAdapters::Transaction#within_new_transaction</code> &#x65B9;&#x6CD5;&#x4E2D;&#x6267;&#x884C;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">within_new_transaction</span><span class="hljs-params">(options = {})</span></span>
  @connection.lock.synchronize <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      transaction = begin_transaction options
      <span class="hljs-keyword">yield</span>
    <span class="hljs-keyword">rescue</span> Exception =&gt; error
      <span class="hljs-keyword">if</span> transaction
        rollback_transaction
        after_failure_actions(transaction, error)
      <span class="hljs-keyword">end</span>
      raise
    <span class="hljs-keyword">ensure</span>
      <span class="hljs-keyword">unless</span> error
        <span class="hljs-keyword">if</span> Thread.current.status == <span class="hljs-string">&quot;aborting&quot;</span>
          rollback_transaction <span class="hljs-keyword">if</span> transaction
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">begin</span>
            commit_transaction
          <span class="hljs-keyword">rescue</span> Exception
            rollback_transaction(transaction) <span class="hljs-keyword">unless</span> transaction.state.completed?
            raise
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x4E0A;&#x8FF0;&#x65B9;&#x6CD5;&#x867D;&#x7136;&#x770B;&#x8D77;&#x6765;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x4F46;&#x662F;&#x65B9;&#x6CD5;&#x7684;&#x903B;&#x8F91;&#x8FD8;&#x662F;&#x8FD8;&#x662F;&#x975E;&#x5E38;&#x6E05;&#x6670;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x4E8B;&#x52A1;&#x6CA1;&#x6709;&#x629B;&#x51FA;&#x4EFB;&#x4F55;&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x7B80;&#x5316;&#x6210;&#x4EE5;&#x4E0B;&#x7684;&#x51E0;&#x884C;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">within_new_transaction</span><span class="hljs-params">(options = {})</span></span>
  @connection.lock.synchronize <span class="hljs-keyword">do</span>
      begin_transaction options
      <span class="hljs-keyword">yield</span>
      commit_transaction
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x7ECF;&#x8FC7;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x6700;&#x540E;&#x4F1A;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x6267;&#x884C; <code>BEGIN</code>&#x3001;SQL &#x8BED;&#x53E5;&#x548C; <code>COMMIT</code> &#x6765;&#x5B8C;&#x6210;&#x6570;&#x636E;&#x7684;&#x6301;&#x4E45;&#x5316;&#x3002;</p>
<h4 id="&#x8FFD;&#x8E2A;&#x5C5E;&#x6027;&#x7684;&#x91CD;&#x7F6E;">&#x8FFD;&#x8E2A;&#x5C5E;&#x6027;&#x7684;&#x91CD;&#x7F6E;</h4>
<p>&#x5F53; <code>ActiveRecord::Transactions#save!</code> &#x901A;&#x8FC7; <code>super</code> &#x5C06;&#x65B9;&#x6CD5;&#x629B;&#x7ED9;&#x4E0A;&#x5C42;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x7531; <code>ActiveRecord::AttributesMethod::Dirty</code> &#x6765;&#x5904;&#x7406;&#x4E86;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save!</span><span class="hljs-params">(*)</span></span>
  <span class="hljs-keyword">super</span>.tap <span class="hljs-keyword">do</span>
    changes_applied
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5982;&#x679C; <code>#save!</code> &#x6700;&#x7EC8;&#x6267;&#x884C;&#x6210;&#x529F;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x6A21;&#x578B;&#x6539;&#x53D8;&#x7684;&#x6807;&#x8BB0;&#x5168;&#x90E8;&#x6E05;&#x9664;&#xFF0C;&#x5BF9;&#x5305;&#x62EC; <code>@changed_attributes</code>&#x3001;<code>@mutation_tracker</code> &#x5728;&#x5185;&#x7684;&#x5B9E;&#x4F8B;&#x53D8;&#x91CF;&#x5168;&#x90E8;&#x91CD;&#x7F6E;&#xFF0C;&#x4E3A;&#x8FFD;&#x8E2A;&#x4E0B;&#x4E00;&#x6B21;&#x6A21;&#x578B;&#x7684;&#x4FEE;&#x6539;&#x505A;&#x51C6;&#x5907;&#x3002;</p>
<h4 id="&#x5B57;&#x6BB5;&#x7684;&#x9A8C;&#x8BC1;">&#x5B57;&#x6BB5;&#x7684;&#x9A8C;&#x8BC1;</h4>
<p>&#x6CBF;&#x7740;&#x6574;&#x4E2A;&#x7EE7;&#x627F;&#x94FE;&#x5F80;&#x4E0B;&#x8D70;&#xFF0C;&#x4E0B;&#x4E00;&#x4E2A;&#x88AB;&#x6267;&#x884C;&#x7684;&#x6A21;&#x5757;&#x5C31;&#x662F; <code>ActiveRecord::Validations</code> &#x4E86;&#xFF0C;&#x6B63;&#x5982;&#x8FD9;&#x4E48;&#x6A21;&#x5757;&#x540D;&#x5B57;&#x6240;&#x6697;&#x793A;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x8FD9;&#x91CC;&#x4F1A;&#x5BF9;&#x6A21;&#x578B;&#x4E2D;&#x7684;&#x5B57;&#x6BB5;&#x8FDB;&#x884C;&#x9A8C;&#x8BC1;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save!</span><span class="hljs-params">(options = {})</span></span>
  perform_validations(options) ? <span class="hljs-keyword">super</span> <span class="hljs-symbol">:</span> raise_validation_error
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x4F7F;&#x7528; <code>#perform_validations</code> &#x65B9;&#x6CD5;&#x9A8C;&#x8BC1;&#x6A21;&#x578B;&#x4E2D;&#x7684;&#x5168;&#x90E8;&#x5B57;&#x6BB5;&#xFF0C;&#x4EE5;&#x6B64;&#x6765;&#x4FDD;&#x8BC1;&#x6240;&#x6709;&#x7684;&#x5B57;&#x6BB5;&#x90FD;&#x7B26;&#x5408;&#x6211;&#x4EEC;&#x7684;&#x9884;&#x671F;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">perform_validations</span><span class="hljs-params">(options = {})</span></span>
  options[<span class="hljs-symbol">:validate</span>] == <span class="hljs-keyword">false</span> || valid?(options[<span class="hljs-symbol">:context</span>])
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5982;&#x679C;&#x5728;&#x8C03;&#x7528; <code>save!</code> &#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x4F20;&#x5165;&#x4E86; <code>validate: false</code> &#x6240;&#x6709;&#x7684;&#x9A8C;&#x8BC1;&#x5C31;&#x90FD;&#x4F1A;&#x88AB;&#x8DF3;&#x8FC7;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <code>#valid?</code> &#x6765;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7684;&#x6A21;&#x578B;&#x662F;&#x5426;&#x5408;&#x6CD5;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x5176;&#x5B9E;&#x4E5F;&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ActiveRecord</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Validations</span></span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">valid?</span><span class="hljs-params">(context = <span class="hljs-keyword">nil</span>)</span></span>
      context ||= default_validation_context
      output = <span class="hljs-keyword">super</span>(context)
      errors.empty? &amp;&amp; output
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ActiveModel</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Validations</span></span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">valid?</span><span class="hljs-params">(context = <span class="hljs-keyword">nil</span>)</span></span>
      current_context, <span class="hljs-keyword">self</span>.validation_context = validation_context, context
      errors.clear
      run_validations!
    <span class="hljs-keyword">ensure</span>
      <span class="hljs-keyword">self</span>.validation_context = current_context
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x7531;&#x4E8E; <code>ActiveModel::Validations</code> &#x662F; <code>ActiveRecord::Validations</code> &#x7684;&#x300E;&#x7236;&#x7C7B;&#x300F;&#xFF0C;&#x6240;&#x4EE5;&#x5728; <code>ActiveRecord::Validations</code> &#x6267;&#x884C; <code>#valid?</code> &#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x6267;&#x884C;&#x7236;&#x7C7B; <code>#run_validations</code> &#x8FD0;&#x884C;&#x5168;&#x90E8;&#x7684;&#x9A8C;&#x8BC1;&#x56DE;&#x8C03;&#x3002;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ActiveModel</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Validations</span></span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_validations!</span></span>
      _run_validate_callbacks
      errors.empty?
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x8FF0;&#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x9A8C;&#x8BC1;&#x662F;&#x5426;&#x6210;&#x529F;&#x5176;&#x5B9E;&#x5E76;&#x4E0D;&#x662F;&#x901A;&#x8FC7;&#x6211;&#x4EEC;&#x5728; <code>validate</code> &#x4E2D;&#x4F20;&#x5165;&#x4E00;&#x4E2A;&#x8FD4;&#x56DE; <code>true/false</code> &#x7684;&#x65B9;&#x6CD5;&#x51B3;&#x5B9A;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x8981;&#x5411;&#x5F53;&#x524D;&#x6A21;&#x578B;&#x7684; <code>errors</code> &#x4E2D;&#x6DFB;&#x52A0;&#x66F4;&#x591A;&#x7684;&#x9519;&#x8BEF;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Invoice</span> &lt; ApplicationRecord</span>
  validate <span class="hljs-symbol">:active_customer</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">active_customer</span></span>
    errors.add(<span class="hljs-symbol">:customer_id</span>, <span class="hljs-string">&quot;is not active&quot;</span>) <span class="hljs-keyword">unless</span> customer.active?
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x7684;&#x53E6;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5; <code>#_run_validate_callbacks</code> &#x5176;&#x5B9E;&#x662F;&#x901A;&#x8FC7; <code>ActiveSupport::Callbacks</code> &#x63D0;&#x4F9B;&#x7684; <code>#define_callbacks</code> &#x65B9;&#x6CD5;&#x52A8;&#x6001;&#x751F;&#x6210;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x5728;&#x5DE5;&#x7A0B;&#x4E2D;&#x641C;&#x7D22;&#x5230;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">define_callbacks</span><span class="hljs-params">(*names)</span></span>
  options = names.extract_options!

  names.each <span class="hljs-keyword">do</span> |name|
    name = name.to_sym
    set_callbacks name, CallbackChain.new(name, options)
    module_eval &lt;&lt;-RUBY, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_run_</span><span class="hljs-comment">#{name}_callbacks(&amp;block)</span></span>
        run_callbacks <span class="hljs-comment">#{name.inspect}, &amp;block</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">_</span><span class="hljs-comment">#{name}_callbacks</span></span>
        get_callbacks(<span class="hljs-comment">#{name.inspect})</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">_</span><span class="hljs-comment">#{name}_callbacks=(value)</span></span>
        set_callbacks(<span class="hljs-comment">#{name.inspect}, value)</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_</span><span class="hljs-comment">#{name}_callbacks</span></span>
        __callbacks[<span class="hljs-comment">#{name.inspect}]</span>
      <span class="hljs-keyword">end</span>
    RUBY
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x77E5;&#x9053;&#x8BE5; <code>#save!</code> &#x5728;&#x5408;&#x9002;&#x7684;&#x65F6;&#x673A;&#x8FD0;&#x884C;&#x4E86;&#x6B63;&#x786E;&#x7684;&#x56DE;&#x8C03;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#xFF0C;&#x5728;&#x540E;&#x9762;&#x7684;&#x6587;&#x7AE0;&#xFF08;&#x53EF;&#x80FD;&#xFF09;&#x4E2D;&#x4F1A;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x6574;&#x4E2A; callbacks &#x7684;&#x5177;&#x4F53;&#x6267;&#x884C;&#x6D41;&#x7A0B;&#x3002;</p>
<h4 id="&#x6570;&#x636E;&#x7684;&#x6301;&#x4E45;&#x5316;">&#x6570;&#x636E;&#x7684;&#x6301;&#x4E45;&#x5316;</h4>
<p><code>#save!</code> &#x7684;&#x8C03;&#x7528;&#x6808;&#x6700;&#x9876;&#x7AEF;&#x5C31;&#x662F; <code>ActiveRecord::Persistence#save!</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save!</span><span class="hljs-params">(*args, &amp;block)</span></span>
  create_or_update(*args, &amp;block) || raise(RecordNotSaved.new(<span class="hljs-string">&quot;Failed to save the record&quot;</span>, <span class="hljs-keyword">self</span>))
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_or_update</span><span class="hljs-params">(*args, &amp;block)</span></span>
  _raise_readonly_record_error <span class="hljs-keyword">if</span> readonly?
  result = new_record? ? _create_record(&amp;block) <span class="hljs-symbol">:</span> _update_record(*args, &amp;block)
  result != <span class="hljs-keyword">false</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6267;&#x884C;&#x4E86; <code>#create_or_update</code> &#x4EE5;&#x53CA; <code>#_create_record</code> &#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x6A21;&#x578B;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_record</span><span class="hljs-params">(attribute_names = <span class="hljs-keyword">self</span>.attribute_names)</span></span>
  attributes_values = arel_attributes_with_values_for_create(attribute_names)
  new_id = <span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span>.unscoped.insert attributes_values
  <span class="hljs-keyword">self</span>.id ||= new_id <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span>.primary_key
  @new_record = <span class="hljs-keyword">false</span>
  <span class="hljs-keyword">yield</span>(<span class="hljs-keyword">self</span>) <span class="hljs-keyword">if</span> block_given?
  id
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x79C1;&#x6709;&#x65B9;&#x6CD5;&#x4E2D;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x6570;&#x636E;&#x7684;&#x63D2;&#x5165;&#x64CD;&#x4F5C;&#x4E86;&#xFF0C;&#x9996;&#x5148;&#x662F;&#x901A;&#x8FC7; <code>ActiveRecord::AttributeMethods#arel_attributes_with_values_for_create</code> &#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x63D2;&#x5165;&#x6570;&#x636E;&#x7684;&#x5B57;&#x5178;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x62EC;&#x4E86;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x8868;&#x5B57;&#x6BB5;&#x548C;&#x5BF9;&#x5E94;&#x7684;&#x5F85;&#x63D2;&#x5165;&#x503C;&#x3002;</p>
<p><img src="images/activerecord/database-statement-insert.png" alt="database-statement-insert"></p>
<p>&#x800C;&#x4E0B;&#x9762;&#x7684; <code>.insert</code> &#x65B9;&#x6CD5;&#x5C31;&#x4F1A;&#x5C06;&#x8FD9;&#x4E2A;&#x5B57;&#x5178;&#x8F6C;&#x6362;&#x6210; SQL &#x8BED;&#x53E5;&#xFF0C;&#x7ECF;&#x8FC7;&#x4E0A;&#x56FE;&#x6240;&#x793A;&#x7684;&#x8C03;&#x7528;&#x6808;&#x6700;&#x7EC8;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x6267;&#x884C;&#x8BED;&#x53E5;&#x5E76;&#x8FD4;&#x56DE;&#x6700;&#x65B0;&#x7684;&#x4E3B;&#x952E;&#x3002;</p>
<h3 id="&#x5C0F;&#x7ED3;">&#x5C0F;&#x7ED3;</h3>
<p>&#x4ECE;&#x6574;&#x4E2A;&#x6A21;&#x578B;&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230; ActiveRecord &#x5BF9;&#x4E8E;&#x4E0D;&#x540C;&#x529F;&#x80FD;&#x7684;&#x7EC4;&#x7EC7;&#x975E;&#x5E38;&#x4F18;&#x96C5;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x975E;&#x5E38;&#x7B80;&#x77ED;&#x5E76;&#x4E14;&#x6613;&#x4E8E;&#x9605;&#x8BFB;&#xFF0C;&#x901A;&#x8FC7;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x540D;&#x548C;&#x6A21;&#x5757;&#x540D;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x591F;&#x660E;&#x786E;&#x7684;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x4E1C;&#x897F;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x7684;&#xFF0C;&#x5BF9;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x4E0D;&#x540C;&#x6267;&#x884C;&#x903B;&#x8F91;&#x4E5F;&#x5206;&#x6563;&#x4E86;&#x4E0D;&#x540C;&#x7684;&#x6A21;&#x5757;&#x4E2D;&#xFF0C;&#x6700;&#x7EC8;&#x4F7F;&#x7528; module &#x52A0;&#x4E0A; include &#x7684;&#x65B9;&#x5F0F;&#x7EC4;&#x7EC7;&#x8D77;&#x6765;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x5BF9;&#x67D0;&#x4E2A;&#x65B9;&#x6CD5;&#x6DFB;&#x52A0;&#x4E00;&#x4E9B;&#x65B0;&#x7684;&#x903B;&#x8F91;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x589E;&#x52A0;&#x66F4;&#x591A;&#x7684; module &#x8FBE;&#x5230;&#x76EE;&#x7684;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x5BF9;&#x6E90;&#x4EE3;&#x7801;&#x7684;&#x9605;&#x8BFB;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5BF9;&#x4E8E; ActiveRecord &#x6765;&#x8BF4;&#xFF0C;<code>#create</code> &#x548C; <code>#save!</code> &#x65B9;&#x6CD5;&#x7684;&#x6267;&#x884C;&#x8DEF;&#x5F84;&#x5176;&#x5B9E;&#x662F;&#x5DEE;&#x4E0D;&#x591A;&#x7684;&#xFF0C;&#x53EA;&#x662F;&#x5728;&#x7EC6;&#x8282;&#x4E0A;&#x6709;&#x4E00;&#x4E9B;&#x4E0D;&#x540C;&#x4E4B;&#x5904;&#x3002;</p>
<p><img src="images/activerecord/actual-callstack-for-activerecord-base-save.png" alt="actual-callstack-for-activerecord-base-save"></p>
<p>&#x867D;&#x7136;&#x6A21;&#x578B;&#x6216;&#x8005;&#x8BF4;&#x6570;&#x636E;&#x884C;&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x6700;&#x7EC8;&#x4F1A;&#x4ECE;&#x5B50;&#x7C7B;&#x4E00;&#x8DEF;&#x6267;&#x884C;&#x5230;&#x7236;&#x7C7B;&#x7684; <code>#save!</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;&#x903B;&#x8F91;&#x7684;<strong>&#x5904;&#x7406;&#x987A;&#x5E8F;</strong>&#x5E76;&#x4E0D;&#x662F;&#x6309;&#x7167;&#x4ECE;&#x5B50;&#x7C7B;&#x5230;&#x7236;&#x7C7B;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E0A;&#x56FE;&#x4E86;&#x89E3;&#x4E0D;&#x540C;&#x6A21;&#x5757;&#x7684;&#x771F;&#x6B63;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x3002;</p>
<h2 id="scope-&#x548C;&#x67E5;&#x8BE2;&#x7684;&#x5B9E;&#x73B0;">Scope &#x548C;&#x67E5;&#x8BE2;&#x7684;&#x5B9E;&#x73B0;</h2>
<p>&#x9664;&#x4E86;&#x6A21;&#x578B;&#x7684;&#x63D2;&#x5165;&#x3001;&#x521B;&#x5EFA;&#x548C;&#x8FC1;&#x79FB;&#x6A21;&#x5757;&#xFF0C;ActiveRecord &#x4E2D;&#x8FD8;&#x6709;&#x53E6;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; Scope &#x548C;&#x67E5;&#x8BE2;&#xFF1B;&#x4E3A;&#x4EC0;&#x4E48;&#x540C;&#x65F6;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E24;&#x4E2A;&#x770B;&#x8D77;&#x6765;&#x6BEB;&#x4E0D;&#x76F8;&#x5E72;&#x7684;&#x5185;&#x5BB9;&#x5462;&#xFF1F;&#x8FD9;&#x662F;&#x56E0;&#x4E3A; Scope &#x548C;&#x67E5;&#x8BE2;&#x662F;&#x5B8C;&#x5168;&#x5206;&#x4E0D;&#x5F00;&#x7684;&#x4E00;&#x4E2A;&#x6574;&#x4F53;&#xFF0C;&#x5728; ActiveRecord &#x7684;&#x5B9E;&#x73B0;&#x4E2D;&#xFF0C;&#x4E24;&#x8005;&#x6709;&#x7740;&#x975E;&#x5E38;&#x7D27;&#x5BC6;&#x7684;&#x8054;&#x7CFB;&#x3002;</p>
<h3 id="activerecordrelation">ActiveRecord::Relation</h3>
<p>&#x5BF9; ActiveRecord &#x7A0D;&#x6709;&#x4E86;&#x89E3;&#x7684;&#x4EBA;&#x90FD;&#x77E5;&#x9053;&#xFF0C;&#x5728;&#x4F7F;&#x7528; ActiveRecord &#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x67E5;&#x8BE2;&#x65B9;&#x6CD5;&#x5176;&#x5B9E;&#x90FD;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; <code>#{Model}::ActiveRecord_Relation</code> &#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x6BD4;&#x5982; <code>User.all</code>&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; User.all.<span class="hljs-keyword">class</span>
=&gt; <span class="hljs-symbol">User:</span><span class="hljs-symbol">:ActiveRecord_Relation</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x91CC;&#x4F7F;&#x7528; pry &#x6765;&#x53EF;&#x4EE5;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x5FEB;&#x901F;&#x7406;&#x89E3;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x5230;&#x5E95;&#x90FD;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#x4E8B;&#x60C5;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; $ User.all

<span class="hljs-symbol">From:</span> lib/active_record/scoping/named.rb @ line <span class="hljs-number">24</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Scoping</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:Named</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:ClassMethods</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">all</span></span>
  <span class="hljs-keyword">if</span> current_scope
    current_scope.clone
  <span class="hljs-keyword">else</span>
    default_scoped
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>#all</code> &#x65B9;&#x6CD5;&#x4E2D;&#x7684;&#x6CE8;&#x91CA;&#x4E2D;&#x4E5F;&#x5199;&#x7740;&#x5B83;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; <code>ActiveRecord::Relation</code> &#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A; ActiveRecord &#x67E5;&#x8BE2;&#x4F53;&#x7CFB;&#x4E2D;&#x7684;&#x5355;&#x4F4D;&#x5143;&#xFF0C;&#x5B83;&#x7684;&#x8C03;&#x7528;&#x5E76;&#x4E0D;&#x6539;&#x53D8;&#x5F53;&#x524D;&#x67E5;&#x8BE2;&#xFF1B;&#x800C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x4F7F;&#x7528; pry &#x53BB;&#x770B;&#x5176;&#x4ED6;&#x7684;&#x65B9;&#x6CD5;&#x4F8B;&#x5982; <code>User.where</code> &#x7684;&#x65F6;&#x5019;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; $ User.where

<span class="hljs-symbol">From:</span> lib/active_record/querying.rb @ line <span class="hljs-number">10</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Querying</span>

delegate <span class="hljs-symbol">:select</span>, <span class="hljs-symbol">:group</span>, <span class="hljs-symbol">:order</span>, <span class="hljs-symbol">:except</span>, <span class="hljs-symbol">:reorder</span>, <span class="hljs-symbol">:limit</span>, <span class="hljs-symbol">:offset</span>, <span class="hljs-symbol">:joins</span>, <span class="hljs-symbol">:left_joins</span>, <span class="hljs-symbol">:left_outer_joins</span>, <span class="hljs-symbol">:or</span>,
         <span class="hljs-symbol">:where</span>, <span class="hljs-symbol">:rewhere</span>, <span class="hljs-symbol">:preload</span>, <span class="hljs-symbol">:eager_load</span>, <span class="hljs-symbol">:includes</span>, <span class="hljs-symbol">:from</span>, <span class="hljs-symbol">:lock</span>, <span class="hljs-symbol">:readonly</span>, <span class="hljs-symbol">:extending</span>,
         <span class="hljs-symbol">:having</span>, <span class="hljs-symbol">:create_with</span>, <span class="hljs-symbol">:distinct</span>, <span class="hljs-symbol">:references</span>, <span class="hljs-symbol">:none</span>, <span class="hljs-symbol">:unscope</span>, <span class="hljs-symbol">:merge</span>, <span class="hljs-symbol">to:</span> <span class="hljs-symbol">:all</span>
</code></pre>
<p>&#x4ECE;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x771F;&#x6B63;&#x5B9E;&#x73B0;&#x4E3A; <code>User</code> &#x7C7B;&#x65B9;&#x6CD5;&#x7684;&#x53EA;&#x6709; <code>.all</code>&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x4F1A;&#x4EE3;&#x7406;&#x7ED9; <code>all</code> &#x65B9;&#x6CD5;&#xFF0C;&#x5728; <code>.all</code> &#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;&#x5BF9;&#x8C61;&#x4E0A;&#x6267;&#x884C;&#xFF1A;</p>
<p><img src="images/activerecord/active-record-relation-delegation.png" alt="active-record-relation-delegation"></p>
<p>&#x6240;&#x6709;&#x76F4;&#x63A5;&#x5728;&#x7C7B;&#x4E0A;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x4F1A;&#x5148;&#x6267;&#x884C; <code>#all</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x4E0B;&#x9762;&#x7684;&#x51E0;&#x79CD;&#x5199;&#x6CD5;&#x662F;&#x5B8C;&#x5168;&#x76F8;&#x540C;&#x7684;&#xFF1A;</p>
<pre><code class="lang-ruby">User    .where(<span class="hljs-symbol">name:</span> <span class="hljs-string">&apos;draven&apos;</span>)
User.all.where(<span class="hljs-symbol">name:</span> <span class="hljs-string">&apos;draven&apos;</span>)
User.all.where(<span class="hljs-symbol">name:</span> <span class="hljs-string">&apos;draven&apos;</span>).all
</code></pre>
<p>&#x5F53;&#x6211;&#x4EEC;&#x4E86;&#x89E3;&#x4E86; <code>.where == .all + #where</code> &#x5C31;&#x53EF;&#x4EE5;&#x518D;&#x4E00;&#x6B21;&#x4F7F;&#x7528; pry &#x6765;&#x67E5;&#x627E;&#x771F;&#x6B63;&#x88AB; ActiveRecord &#x5B9E;&#x73B0;&#x7684; <code>#where</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; $ User.all.where

<span class="hljs-symbol">From:</span> lib/active_record/relation/query_methods.rb @ line <span class="hljs-number">599</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:QueryMethods</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">where</span><span class="hljs-params">(opts = <span class="hljs-symbol">:chain</span>, *rest)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-symbol">:chain</span> == opts
    WhereChain.new(spawn)
  <span class="hljs-keyword">elsif</span> opts.blank?
    <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">else</span>
    spawn.where!(opts, *rest)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x5206;&#x6790;&#x67E5;&#x8BE2;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x9009;&#x62E9;&#x51E0;&#x4E2A;&#x5E38;&#x89C1;&#x7684;&#x65B9;&#x6CD5;&#x4F5C;&#x4E3A;&#x5165;&#x53E3;&#xFF0C;&#x5C3D;&#x53EF;&#x80FD;&#x5F97;&#x8986;&#x76D6;&#x8F83;&#x591A;&#x7684;&#x67E5;&#x8BE2;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x589E;&#x52A0;&#x6211;&#x4EEC;&#x5BF9; ActiveRecord &#x7684;&#x7406;&#x89E3;&#x548C;&#x8BA4;&#x8BC6;&#x3002;</p>
<h3 id="&#x4ECE;-userall-&#x5F00;&#x59CB;">&#x4ECE; User.all &#x5F00;&#x59CB;</h3>
<p>&#x518D;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x4E0A;&#x9762;&#x770B;&#x5230;&#x7684; <code>ActiveRecord::Relation.all</code> &#x65B9;&#x6CD5;&#xFF0C;&#x65E0;&#x8BBA;&#x662F; <code>#current_scope</code> &#x8FD8;&#x662F; <code>#default_scoped</code> &#x5176;&#x5B9E;&#x8FD4;&#x56DE;&#x7684;&#x90FD;&#x662F;&#x5F53;&#x524D;&#x7684; <code>ActiveRecord</code> &#x5BF9;&#x8C61;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">all</span></span>
  <span class="hljs-keyword">if</span> current_scope
    current_scope.clone
  <span class="hljs-keyword">else</span>
    default_scoped
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4 id="currentscope-&#x548C;-defaultscope">current_scope &#x548C; default_scope</h4>
<p>&#x5982;&#x679C;&#x5F53;&#x524D;&#x6CA1;&#x6709; <code>#current_scope</code> &#x90A3;&#x4E48;&#xFF0C;&#x5C31;&#x4F1A;&#x8C03;&#x7528; <code>#default_scoped</code> &#x8FD4;&#x56DE;&#x54CD;&#x5E94;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x5426;&#x5219;&#x5C31;&#x4F1A; clone &#x5F53;&#x524D;&#x5BF9;&#x8C61;&#x5E76;&#x8FD4;&#x56DE;&#xFF0C;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x4E3E;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x8BC1;&#x660E;&#x8FD9;&#x91CC;&#x7684;&#x731C;&#x6D4B;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; User.current_scope
=&gt; nil
pry(main)&gt; User.all.current_scope
  User Load (<span class="hljs-number">0</span>.<span class="hljs-number">1</span>ms)  SELECT <span class="hljs-string">&quot;users&quot;</span>.* FROM <span class="hljs-string">&quot;users&quot;</span>
=&gt; []
pry(main)&gt; User.all.current_scope.<span class="hljs-keyword">class</span>
=&gt; <span class="hljs-symbol">User:</span><span class="hljs-symbol">:ActiveRecord_Relation</span>
</code></pre>
<p><code>.current_scope</code> &#x662F;&#x5B58;&#x50A8;&#x5728;&#x4F4D;&#x4E8E;&#x7EBF;&#x7A0B;&#x53D8;&#x91CF;&#x7684; <code>ScopeRegistry</code> &#x4E2D;&#xFF0C;&#x5B83;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5F53;&#x524D;&#x7684;&#x67E5;&#x8BE2;&#x8BED;&#x53E5;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x5B58;&#x50A8;&#x7740;&#x8FD9;&#x4E00;&#x6B21;&#x94FE;&#x5F0F;&#x8C03;&#x7528;&#x9020;&#x6210;&#x7684;&#x5168;&#x90E8;&#x526F;&#x4F5C;&#x7528;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">current_scope</span><span class="hljs-params">(skip_inherited_scope = <span class="hljs-keyword">false</span>)</span></span>
  ScopeRegistry.value_for(<span class="hljs-symbol">:current_scope</span>, <span class="hljs-keyword">self</span>, skip_inherited_scope)
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x800C; <code>.default_scoped</code> &#x5C31;&#x662F;&#x5728;&#x5F53;&#x524D;&#x67E5;&#x8BE2;&#x94FE;&#x521A;&#x5F00;&#x59CB;&#x65F6;&#x6267;&#x884C;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x6267;&#x884C;&#x7B2C;&#x4E00;&#x4E2A;&#x67E5;&#x8BE2;&#x65B9;&#x6CD5;&#x4E4B;&#x524D; <code>.current_scope</code> &#x4E00;&#x5B9A;&#x4E3A;&#x7A7A;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">default_scoped</span><span class="hljs-params">(scope = relation)</span></span>
  build_default_scope(scope) || scope
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build_default_scope</span><span class="hljs-params">(base_rel = <span class="hljs-keyword">nil</span>)</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> abstract_class?

  <span class="hljs-keyword">if</span> default_scopes.any?
    base_rel ||= relation
    evaluate_default_scope <span class="hljs-keyword">do</span>
      default_scopes.inject(base_rel) <span class="hljs-keyword">do</span> |default_scope, scope|
        scope = scope.respond_to?(<span class="hljs-symbol">:to_proc</span>) ? scope <span class="hljs-symbol">:</span> scope.method(<span class="hljs-symbol">:call</span>)
        default_scope.merge(base_rel.instance_exec(&amp;scope))
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5F53;&#x6211;&#x4EEC;&#x5728; Rails &#x7684;&#x6A21;&#x578B;&#x5C42;&#x4E2D;&#x4F7F;&#x7528; <code>.default_scope</code> &#x5B9A;&#x4E49;&#x4E00;&#x4E9B;&#x9ED8;&#x8BA4;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x7684; block &#x90FD;&#x6362;&#x88AB;&#x8F6C;&#x6362;&#x6210; <code>Proc</code> &#x5BF9;&#x8C61;&#x6700;&#x7EC8;&#x6DFB;&#x52A0;&#x5230; <code>default_scopes</code> &#x6570;&#x7EC4;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">default_scope</span><span class="hljs-params">(scope = <span class="hljs-keyword">nil</span>)</span></span> <span class="hljs-comment"># :doc:</span>
  scope = Proc.new <span class="hljs-keyword">if</span> block_given?
  <span class="hljs-comment"># ...</span>
  <span class="hljs-keyword">self</span>.default_scopes += [scope]
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x7684; <code>.build_default_scope</code> &#x65B9;&#x6CD5;&#x5176;&#x5B9E;&#x53EA;&#x662F;&#x5728; <code>default_scopes</code> &#x6570;&#x7EC4;&#x4E0D;&#x4E3A;&#x7A7A;&#x65F6;&#xFF0C;&#x5C06;&#x5F53;&#x524D;&#x7684; <code>Relation</code> &#x5BF9;&#x8C61;&#x548C;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x5168;&#x90E8; scope &#x4E00;&#x4E00; <code>#merge</code> &#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x7684; <code>Relation</code> &#x5BF9;&#x8C61;&#x3002;</p>
<h4 id="activerecordrelation-&#x5BF9;&#x8C61;">ActiveRecord::Relation &#x5BF9;&#x8C61;</h4>
<p><code>.default_scoped</code> &#x65B9;&#x6CD5;&#x7684;&#x53C2;&#x6570; <code>scope</code> &#x5176;&#x5B9E;&#x5C31;&#x6709;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x503C; <code>#relation</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x9ED8;&#x8BA4;&#x503C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E00;&#x4E2A; <code>Relation</code> &#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">relation</span></span>
  relation = Relation.create(<span class="hljs-keyword">self</span>, arel_table, predicate_builder)

  <span class="hljs-keyword">if</span> finder_needs_type_condition? &amp;&amp; !ignore_default_scope?
    relation.where(type_condition).create_with(inheritance_column.to_s =&gt; sti_name)
  <span class="hljs-keyword">else</span>
    relation
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>Relation.create</code> &#x5BF9;&#x8C61;&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x5176;&#x5B9E;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x77E5;&#x9053;&#x7ECF;&#x8FC7; ActiveRecord &#x4E00;&#x7CFB;&#x5217;&#x7684;&#x75AF;&#x72C2;&#x64CD;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x5C06;&#x51E0;&#x4E2A;&#x53C2;&#x6570;&#x4F20;&#x5165; <code>.new</code> &#x65B9;&#x6CD5;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A; <code>ActiveRecord::Relation</code> &#x5B9E;&#x4F8B;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Relation</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(klass, table, predicate_builder, values = {})</span></span>
    @klass  = klass
    @table  = table
    @values = values
    @offsets = {}
    @loaded = <span class="hljs-keyword">false</span>
    @predicate_builder = predicate_builder
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5F53;&#x6267;&#x884C;&#x7684;&#x662F; <code>#all</code>&#x3001;<code>.all</code> &#x6216;&#x8005;&#x7EDD;&#x5927;&#x591A;&#x6570;&#x67E5;&#x8BE2;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x90FD;&#x4F1A;&#x76F4;&#x63A5;&#x5C06;&#x8FD9;&#x4E2A;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x8FD4;&#x56DE;&#x6765;&#x63A5;&#x53D7;&#x968F;&#x540E;&#x7684;&#x94FE;&#x5F0F;&#x8C03;&#x7528;&#x3002;</p>
<h3 id="where-&#x65B9;&#x6CD5;">where &#x65B9;&#x6CD5;</h3>
<p>&#x76F8;&#x6BD4;&#x4E8E; <code>#all</code>&#x3001;<code>#where</code> &#x67E5;&#x8BE2;&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x590D;&#x6742;&#x591A;&#x4E86;&#xFF0C;&#x4E0D;&#x50CF; <code>#all</code> &#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684; <code>Relation</code> &#x5BF9;&#x8C61;&#xFF0C;<code>#where</code> &#x7531; <code>WhereClause</code> &#x4EE5;&#x53CA; <code>WhereClauseFactory</code> &#x7B49;&#x7C7B;&#x5171;&#x540C;&#x5904;&#x7406;&#xFF1B;&#x5728; <code>#where</code> &#x7684;&#x6700;&#x6B63;&#x5E38;&#x7684;&#x6267;&#x884C;&#x8DEF;&#x5F84;&#x4E2D;&#xFF0C;&#x5B83;&#x4F1A;&#x6267;&#x884C; <code>#where!</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">where</span><span class="hljs-params">(opts = <span class="hljs-symbol">:chain</span>, *rest)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-symbol">:chain</span> == opts
    WhereChain.new(spawn)
  <span class="hljs-keyword">elsif</span> opts.blank?
    <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">else</span>
    spawn.where!(opts, *rest)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">where!</span><span class="hljs-params">(opts, *rest)</span></span>
  opts = sanitize_forbidden_attributes(opts)
  references!(PredicateBuilder.references(opts)) <span class="hljs-keyword">if</span> Hash === opts
  <span class="hljs-keyword">self</span>.where_clause += where_clause_factory.build(opts, rest)
  <span class="hljs-keyword">self</span>
<span class="hljs-keyword">end</span>
</code></pre>
<blockquote>
<p><code>#spawn</code> &#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BF9;&#x5F53;&#x524D;&#x7684; <code>Relation</code> &#x5BF9;&#x8C61;&#x8FDB;&#x884C; <code>#clone</code>&#x3002;</p>
</blockquote>
<p>&#x67E5;&#x8BE2;&#x65B9;&#x6CD5; <code>#where!</code> &#x4E2D;&#x7684;&#x56DB;&#x884C;&#x4EE3;&#x7801;&#x53EA;&#x6709;&#x4E00;&#x884C;&#x4EE3;&#x7801;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x8C03;&#x7528; <code>WhereClauseFactory#build</code> &#x751F;&#x6210;&#x4E00;&#x6761; where &#x67E5;&#x8BE2;&#x5E76;&#x5B58;&#x50A8;&#x5230;&#x5F53;&#x524D;&#x5BF9;&#x8C61;&#x7684; <code>where_clause</code> &#x4E2D;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#x5E76;&#x4E0D;&#x4F1A;&#x751F;&#x6210; SQL&#xFF0C;&#x800C;&#x662F;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A; <code>WhereClause</code> &#x5BF9;&#x8C61;&#xFF0C;&#x5176;&#x4E2D;&#x5B58;&#x50A8;&#x7740; SQL &#x8282;&#x70B9;&#x6811;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; User.where(<span class="hljs-symbol">name:</span> <span class="hljs-string">&apos;draven&apos;</span>).where_clause
=&gt; #&lt;ActiveRecord::Relation::WhereClause:0x007fe5a10bf2c8
 @binds=
  [#&lt;ActiveRecord::Relation::QueryAttribute:0x007fe5a10bf4f8
    @name=&quot;name&quot;,
    @original_attribute=nil,
    @type=#&lt;ActiveModel::Type::String:0x007fe59d33f2e0 @limit=nil, @precision=nil, @scale=nil&gt;,
    @value_before_type_cast=<span class="hljs-string">&quot;draven&quot;</span>&gt;],
 @predicates=
  [#&lt;Arel::Nodes::Equality:0x007fe5a10bf368
    @left=
     #&lt;struct Arel::Attributes::Attribute
      relation=
       #&lt;Arel::Table:0x007fe59cc87830
        @name=&quot;users&quot;,
        @table_alias=nil,
        @type_caster=
         #&lt;ActiveRecord::TypeCaster::Map:0x007fe59cc87bf0
          @types=
           User(id: integer, avatar: string, nickname: string, wechat: string, name: string, gender: integer, school: string, grade: string, major: string, completed: boolean, created_at: datetime, updated_at: datetime, mobile: string, admin: boolean)&gt;&gt;,
      name=<span class="hljs-string">&quot;name&quot;</span>&gt;,
    @right=#&lt;Arel::Nodes::BindParam:0x007fe5a10bf520&gt;&gt;]&gt;
</code></pre>
<blockquote>
<p><a href="https://github.com/rails/arel" target="_blank">Arel</a> &#x662F;&#x4E00;&#x4E2A; Ruby &#x7684; SQL &#x62BD;&#x8C61;&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x7BA1;&#x7406;&#x5668;&#xFF0C;ActiveRecord &#x67E5;&#x8BE2;&#x7684;&#x8FC7;&#x7A0B;&#x90FD;&#x662F;&#x60F0;&#x6027;&#x7684;&#xFF0C;&#x5728;&#x771F;&#x6B63;&#x8FDB;&#x5165;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;&#x4E4B;&#x524D;&#xFF0C;&#x67E5;&#x8BE2;&#x6761;&#x4EF6;&#x90FD;&#x662F;&#x4EE5;&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x5F62;&#x5F0F;&#x5B58;&#x50A8;&#x7684;&#x3002;</p>
</blockquote>
<p>&#x5728;&#x8FD9;&#x91CC;&#x4E0D;&#x50CF;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD; SQL &#x8BED;&#x6CD5;&#x6811;&#x7684;&#x751F;&#x6210;&#x8FC7;&#x7A0B;&#xFF0C;&#x56E0;&#x4E3A;&#x8FC7;&#x7A0B;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x4E5F;&#x6CA1;&#x6709;&#x592A;&#x5927;&#x7684;&#x610F;&#x4E49;&#x3002;</p>
<h3 id="order-&#x65B9;&#x6CD5;">order &#x65B9;&#x6CD5;</h3>
<p>&#x9664;&#x4E86; <code>#where</code> &#x65B9;&#x6CD5;&#x4E4B;&#x5916;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x8FD8;&#x60F3;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x5E38;&#x7528;&#x7684;&#x65B9;&#x6CD5; <code>#order</code>&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">order</span><span class="hljs-params">(*args)</span></span>
  check_if_method_has_arguments!(<span class="hljs-symbol">:order</span>, args)
  spawn.order!(*args)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">order!</span><span class="hljs-params">(*args)</span></span>
  preprocess_order_args(args)
  <span class="hljs-keyword">self</span>.order_values += args
  <span class="hljs-keyword">self</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4E0E; <code>#where</code> &#x975E;&#x5E38;&#x76F8;&#x4F3C;&#xFF0C;&#x5728;&#x8C03;&#x7528;&#x6808;&#x4E2D;&#x90FD;&#x4F1A;&#x6267;&#x884C;&#x53E6;&#x4E00;&#x4E2A;&#x5E26;&#x6709; <code>!</code> &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x4E5F;&#x90FD;&#x4F1A;&#x5411;&#x81EA;&#x5DF1;&#x6301;&#x6709;&#x7684;&#x67D0;&#x4E2A;&#x300E;&#x5C5E;&#x6027;&#x300F;&#x8FFD;&#x52A0;&#x4E00;&#x4E9B;&#x53C2;&#x6570;&#xFF0C;&#x53C2;&#x6570;&#x7684;&#x5904;&#x7406;&#x4E5F;&#x6709;&#x70B9;&#x590D;&#x6742;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x770B;&#x4E00;&#x770B;&#x5C31;&#x597D;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">preprocess_order_args</span><span class="hljs-params">(order_args)</span></span>
  order_args.map! <span class="hljs-keyword">do</span> |arg|
    klass.send(<span class="hljs-symbol">:sanitize_sql_for_order</span>, arg)
  <span class="hljs-keyword">end</span>
  order_args.flatten!
  validate_order_args(order_args)

  references = order_args.grep(String)
  references.map! { |arg| arg =~ <span class="hljs-regexp">/^([a-zA-Z]\w*)\.(\w+)/</span> &amp;&amp; $1 }.compact!
  references!(references) <span class="hljs-keyword">if</span> references.any?

  <span class="hljs-comment"># if a symbol is given we prepend the quoted table name</span>
  order_args.map! <span class="hljs-keyword">do</span> |arg|
    <span class="hljs-keyword">case</span> arg
    <span class="hljs-keyword">when</span> Symbol
      arel_attribute(arg).asc
    <span class="hljs-keyword">when</span> Hash
      arg.map { |field, dir|
        <span class="hljs-keyword">case</span> field
        <span class="hljs-keyword">when</span> <span class="hljs-symbol">Arel:</span><span class="hljs-symbol">:Nodes</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:SqlLiteral</span>
          field.send(dir.downcase)
        <span class="hljs-keyword">else</span>
          arel_attribute(field).send(dir.downcase)
        <span class="hljs-keyword">end</span>
      }
    <span class="hljs-keyword">else</span>
      arg
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>.flatten!
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x540C;&#x6837;&#x7684;&#xFF0C;<code>#order</code> &#x65B9;&#x6CD5;&#x7684;&#x4F7F;&#x7528;&#x4E5F;&#x4F1A;&#x5411; <code>order_values</code> &#x6570;&#x7EC4;&#x4E2D;&#x6DFB;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x8BED;&#x6CD5;&#x5143;&#x7D20;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; User.order(<span class="hljs-symbol">name:</span> <span class="hljs-symbol">:desc</span>).order_values
=&gt; [#&lt;Arel::Nodes::Descending:0x007fe59ce4f190
  @expr=
   #&lt;struct Arel::Attributes::Attribute
    relation=
     #&lt;Arel::Table:0x007fe59cc87830
      @name=&quot;users&quot;,
      @table_alias=nil,
      @type_caster=
       #&lt;ActiveRecord::TypeCaster::Map:0x007fe59cc87bf0
        @types=
         User(id: integer, avatar: string, nickname: string, wechat: string, name: string, gender: integer, school: string, grade: string, major: string, completed: boolean, created_at: datetime, updated_at: datetime, mobile: string, admin: boolean)&gt;&gt;,
    name=<span class="hljs-symbol">:name&gt;&gt;</span>]
</code></pre>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x80FD;&#x770B;&#x5230;&#x4E0E; Arel &#x76F8;&#x5173;&#x7684;&#x5404;&#x79CD;&#x8282;&#x70B9;&#xFF0C;&#x53EF;&#x4EE5;&#x5927;&#x81F4;&#x7406;&#x89E3;&#x4E0A;&#x8FF0;&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x4F5C;&#x7528;&#x3002;</p>
<h3 id="&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x5B58;&#x50A8;">&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x5B58;&#x50A8;</h3>
<p>&#x65E0;&#x8BBA;&#x662F; <code>#where</code> &#x8FD8;&#x662F; <code>#order</code> &#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x4EEC;&#x5176;&#x5B9E;&#x90FD;&#x4F1A;&#x5411;&#x5F53;&#x524D;&#x7684; <code>Relation</code> &#x5BF9;&#x8C61;&#x4E2D;&#x8FFD;&#x52A0;&#x76F8;&#x5E94;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x8282;&#x70B9;&#xFF0C;&#x800C;&#x9664;&#x4E86;&#x4E0A;&#x8FF0;&#x7684;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x4E4B;&#x5916; <code>#from</code>&#x3001;<code>#distinct</code>&#x3001;<code>#lock</code>&#x3001;<code>#limit</code> &#x7B49;&#x7B49;&#xFF0C;&#x51E0;&#x4E4E;&#x6240;&#x6709;&#x7684;&#x67E5;&#x8BE2;&#x65B9;&#x6CD5;&#x90FD;&#x4F1A;&#x6539;&#x53D8; <code>Relation</code> &#x4E2D;&#x7684;&#x67D0;&#x4E2A;&#x503C;&#xFF0C;&#x7136;&#x800C;&#x6240;&#x6709;&#x7684;&#x503C;&#x5176;&#x5B9E;&#x90FD;&#x662F;&#x901A;&#x8FC7; <code>@values</code> &#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;&#x53D8;&#x91CF;&#x5B58;&#x50A8;&#x7684;&#xFF1A;</p>
<p><img src="images/activerecord/activerecord-relation-value-methods.png" alt="activerecord-relation-value-methods"></p>
<p><code>@values</code> &#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x503C;&#x5206;&#x4E3A;&#x4E09;&#x7C7B;&#xFF0C;<code>SINGLE_VALUE</code>&#x3001;<code>MULTI_VALUE</code> &#x548C; <code>CLAUSE</code>&#xFF0C;&#x8FD9;&#x4E09;&#x7C7B;&#x5C5E;&#x6027;&#x4F1A;&#x6309;&#x7167;&#x4E0B;&#x9762;&#x7684;&#x89C4;&#x5219;&#x5B58;&#x50A8;&#x5728; <code>@values</code> &#x4E2D;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-symbol">Relation:</span><span class="hljs-symbol">:VALUE_METHODS</span>.each <span class="hljs-keyword">do</span> |name|
  method_name = \
    <span class="hljs-keyword">case</span> name
    <span class="hljs-keyword">when</span> *<span class="hljs-symbol">Relation:</span><span class="hljs-symbol">:MULTI_VALUE_METHODS</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&quot;<span class="hljs-subst">#{name}</span>_values&quot;</span>
    <span class="hljs-keyword">when</span> *<span class="hljs-symbol">Relation:</span><span class="hljs-symbol">:SINGLE_VALUE_METHODS</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&quot;<span class="hljs-subst">#{name}</span>_value&quot;</span>
    <span class="hljs-keyword">when</span> *<span class="hljs-symbol">Relation:</span><span class="hljs-symbol">:CLAUSE_METHODS</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&quot;<span class="hljs-subst">#{name}</span>_clause&quot;</span>
    <span class="hljs-keyword">end</span>
  class_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-comment">#{method_name}                   # def includes_values</span></span>
      get_value(<span class="hljs-comment">#{name.inspect})         #   get_value(:includes)</span>
    <span class="hljs-keyword">end</span>                                  <span class="hljs-comment"># end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-comment">#{method_name}=(value)           # def includes_values=(value)</span></span>
      set_value(<span class="hljs-comment">#{name.inspect}, value)  #   set_value(:includes, value)</span>
    <span class="hljs-keyword">end</span>                                  <span class="hljs-comment"># end</span>
  CODE
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5404;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x503C;&#x5728;&#x6700;&#x540E;&#x90FD;&#x4F1A;&#x6309;&#x7167;&#x4E00;&#x5B9A;&#x7684;&#x547D;&#x540D;&#x89C4;&#x5219;&#xFF0C;&#x5B58;&#x50A8;&#x5728;&#x8FD9;&#x4E2A; <code>@values</code> &#x5B57;&#x5178;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_value</span><span class="hljs-params">(name)</span></span>
  @values[name] || default_value_for(name)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_value</span><span class="hljs-params">(name, value)</span></span>
  assert_mutability!
  @values[name] = value
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x5728;&#x4E00;&#x4E2A;&#x67E5;&#x8BE2;&#x94FE;&#x4E2D;&#x8BBF;&#x95EE; <code>#values</code> &#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x5176;&#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x6240;&#x6709;&#x67E5;&#x8BE2;&#x6761;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; User.where(<span class="hljs-symbol">name:</span> <span class="hljs-string">&apos;draven&apos;</span>).order(<span class="hljs-symbol">name:</span> <span class="hljs-symbol">:desc</span>).values
=&gt; {<span class="hljs-symbol">:references=&gt;[]</span>,
 <span class="hljs-symbol">:where=&gt;</span>
  <span class="hljs-comment">#&lt;ActiveRecord::Relation::WhereClause:0x007fe59d14d860&gt;,</span>
 <span class="hljs-symbol">:order=&gt;</span>
  [#&lt;Arel::Nodes::Descending:0x007fe59d14cd98&gt;]}
</code></pre>
<p>&#x5F88;&#x591A; ActiveRecord &#x7684;&#x4F7F;&#x7528;&#x8005;&#x5176;&#x5B9E;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x90FD;&#x611F;&#x89C9;&#x5728;&#x5404;&#x79CD;&#x94FE;&#x5F0F;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x65F6;&#x6CA1;&#x6709;&#x6539;&#x53D8;&#x4EFB;&#x4F55;&#x4E8B;&#x60C5;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x53EF;&#x4EE5;&#x4EFB;&#x610F;&#x7EC4;&#x5408;&#x8FDB;&#x884C;&#x94FE;&#x5F0F;&#x8C03;&#x7528;&#xFF0C;&#x5176;&#x5B9E;&#x6BCF;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x5BF9; <code>@values</code> &#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x4E86;&#x4FEE;&#x6539;&#xFF0C;&#x53EA;&#x662F; ActiveRecord &#x5F88;&#x597D;&#x5730;&#x5C06;&#x5B83;&#x9690;&#x85CF;&#x4E86;&#x5E55;&#x540E;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x611F;&#x77E5;&#x5230;&#x5B83;&#x7684;&#x5B58;&#x5728;&#x3002;</p>
<h3 id="scope-&#x65B9;&#x6CD5;">scope &#x65B9;&#x6CD5;</h3>
<p>&#x76F8;&#x6BD4;&#x4E8E; <code>.default_scope</code> &#x8FD9;&#x4E2A;&#x7C7B;&#x65B9;&#x6CD5;&#x53EA;&#x662F;&#x6539;&#x53D8;&#x4E86;&#x5F53;&#x524D;&#x6A21;&#x578B;&#x4E2D;&#x7684; <code>default_scopes</code> &#x6570;&#x7EC4;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5; <code>.scope</code> &#x4F1A;&#x4E3A;&#x5F53;&#x524D;&#x7C7B;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7C7B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-symbol">From:</span> lib/active_record/scoping/named.rb @ line <span class="hljs-number">155</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Scoping</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:Named</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:ClassMethods</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scope</span><span class="hljs-params">(name, body, &amp;block)</span></span>
  extension = Module.new(&amp;block) <span class="hljs-keyword">if</span> block

  <span class="hljs-keyword">if</span> body.respond_to?(<span class="hljs-symbol">:to_proc</span>)
    singleton_class.send(<span class="hljs-symbol">:define_method</span>, name) <span class="hljs-keyword">do</span> |*args|
      scope = all.scoping { instance_exec(*args, &amp;body) }
      scope = scope.extending(extension) <span class="hljs-keyword">if</span> extension
      scope || all
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span>
    singleton_class.send(<span class="hljs-symbol">:define_method</span>, name) <span class="hljs-keyword">do</span> |*args|
      scope = all.scoping { body.call(*args) }
      scope = scope.extending(extension) <span class="hljs-keyword">if</span> extension
      scope || all
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x4E0A;&#x8FF0;&#x65B9;&#x6CD5;&#x4F1A;&#x76F4;&#x63A5;&#x5728;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x5355;&#x7C7B;&#x4E0A;&#x901A;&#x8FC7; <code>define_methods</code> &#x4E3A;&#x5F53;&#x524D;&#x7C7B;&#x5B9A;&#x4E49;&#x7C7B;&#x65B9;&#x6CD5;&#xFF0C;&#x5B9A;&#x4E49;&#x7684;&#x65B9;&#x6CD5;&#x4F1A;&#x5728;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x7684; <code>.all</code> &#x7684;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4E0A;&#x6267;&#x884C; <code>#scoping</code>&#xFF0C;&#x5B58;&#x50A8;&#x5F53;&#x524D;&#x6267;&#x884C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x6267;&#x884C;&#x4F20;&#x5165;&#x7684; block&#xFF0C;&#x518D;&#x6062;&#x590D; <code>current_scope</code>&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scoping</span></span>
  previous, klass.current_scope = klass.current_scope(<span class="hljs-keyword">true</span>), <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">yield</span>
<span class="hljs-keyword">ensure</span>
  klass.current_scope = previous
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x6709;&#x4E00;&#x4E2A;&#x53EF;&#x80FD;&#x5F88;&#x591A;&#x4EBA;&#x4ECE;&#x6765;&#x6CA1;&#x7528;&#x8FC7;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x5C31;&#x662F;&#x5728; <code>.scope</code> &#x65B9;&#x6CD5;&#x4E2D;&#x4F20;&#x5165;&#x4E00;&#x4E2A; block&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>
  scope <span class="hljs-symbol">:male</span>, -&gt; { where <span class="hljs-symbol">gender:</span> <span class="hljs-symbol">:male</span> } <span class="hljs-keyword">do</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">twenty</span></span>
      where <span class="hljs-symbol">age:</span> <span class="hljs-number">20</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

pry(main)&gt; User.male.twenty
<span class="hljs-comment">#=&gt; &lt;#User:0x007f98f3d61c38&gt;</span>
pry(main)&gt; User.twenty
<span class="hljs-comment">#=&gt; NoMethodError: undefined method `twenty&apos; for #&lt;Class:0x007f98f5c7b2b8&gt;</span>
pry(main)&gt; User.female.twenty
<span class="hljs-comment">#=&gt; NoMethodError: undefined method `twenty&apos; for #&lt;User::ActiveRecord_Relation:0x007f98f5d950e0&gt;</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x4F20;&#x5165;&#x7684; block &#x53EA;&#x4F1A;&#x5728;&#x5F53;&#x524D; <code>Relation</code> &#x5BF9;&#x8C61;&#x7684;&#x5355;&#x7C7B;&#x4E0A;&#x6DFB;&#x52A0;&#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x5B9A;&#x4E49;&#x4E00;&#x4E9B;&#x4E0D;&#x60F3;&#x5728;&#x5176;&#x4ED6;&#x4F5C;&#x7528;&#x57DF;&#x4F7F;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extending</span><span class="hljs-params">(*modules, &amp;block)</span></span>
  <span class="hljs-keyword">if</span> modules.any? || block
    spawn.extending!(*modules, &amp;block)
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">self</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extending!</span><span class="hljs-params">(*modules, &amp;block)</span></span>
  modules &lt;&lt; Module.new(&amp;block) <span class="hljs-keyword">if</span> block
  modules.flatten!
  <span class="hljs-keyword">self</span>.extending_values += modules
  extend(*extending_values) <span class="hljs-keyword">if</span> extending_values.any?
  <span class="hljs-keyword">self</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x800C; <code>extending</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x786E;&#x5B9E;&#x4E0E;&#x6211;&#x4EEC;&#x9884;&#x671F;&#x7684;&#x4E00;&#x6837;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;&#x65B0;&#x7684; <code>Module</code> &#x5BF9;&#x8C61;&#x4E4B;&#x540E;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528; <code>#extend</code> &#x5C06;&#x5176;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x6302;&#x8F7D;&#x5F53;&#x524D;&#x5BF9;&#x8C61;&#x7684;&#x5355;&#x7C7B;&#x4E0A;&#x3002;</p>
<h3 id="&#x5C0F;&#x7ED3;">&#x5C0F;&#x7ED3;</h3>
<p>&#x5230;&#x8FD9;&#x91CC;&#x4E3A;&#x6B62;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9; ActiveRecord &#x4E2D;&#x67E5;&#x8BE2;&#x7684;&#x5206;&#x6790;&#x5C31;&#x5DF2;&#x7ECF;&#x6BD4;&#x8F83;&#x5168;&#x9762;&#x4E86;&#xFF0C;&#x4ECE;&#x6700;&#x7EC8;&#x8981;&#x7684; <code>Relation</code> &#x5BF9;&#x8C61;&#xFF0C;&#x5230;&#x5E38;&#x89C1;&#x7684; <code>#all</code>&#x3001;<code>#where</code> &#x548C; <code>#order</code> &#x65B9;&#x6CD5;&#xFF0C;&#x5230; ActiveRecord &#x5BF9;&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x5B58;&#x50A8;&#xFF0C;&#x5982;&#x4F55;&#x4E0E; Arel &#x8FDB;&#x884C;&#x534F;&#x4F5C;&#xFF0C;&#x5728;&#x6700;&#x540E;&#x6211;&#x4EEC;&#x4E5F;&#x4ECB;&#x7ECD;&#x4E86; <code>.scope</code> &#x65B9;&#x6CD5;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF0C;&#x5BF9;&#x4E8E;&#x5176;&#x5B83;&#x65B9;&#x6CD5;&#x6216;&#x8005;&#x529F;&#x80FD;&#x7684;&#x5B9E;&#x73B0;&#x5176;&#x5B9E;&#x4E5F;&#x90FD;&#x5927;&#x540C;&#x5C0F;&#x5F02;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x5C55;&#x5F00;&#x7EC6;&#x8C08;&#x4E86;&#x3002;</p>
<h2 id="&#x6A21;&#x578B;&#x7684;&#x5173;&#x7CFB;">&#x6A21;&#x578B;&#x7684;&#x5173;&#x7CFB;</h2>
<p>&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#x7684; ORM&#xFF0C;ActiveRecord &#x4E00;&#x5B9A;&#x8981;&#x63D0;&#x4F9B;&#x5BF9;&#x6A21;&#x578B;&#x4E4B;&#x95F4;&#x5173;&#x7CFB;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x5B83;&#x4E3A;&#x6A21;&#x578B;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#x5EFA;&#x7ACB;&#x63D0;&#x4F9B;&#x4E86;&#x56DB;&#x4E2A;&#x7C7B;&#x65B9;&#x6CD5; <code>has_many</code>&#x3001;<code>has_one</code>&#x3001;<code>belongs_to</code> &#x548C; <code>has_and_belongs_to_many</code>&#xFF0C;&#x5728;&#x6587;&#x7AE0;&#x7684;&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x4ECE;&#x4E0A;&#x9762;&#x51E0;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x9009;&#x62E9;&#x4E00;&#x90E8;&#x5206;&#x4ECB;&#x7ECD; ActiveRecord &#x662F;&#x5982;&#x4F55;&#x5EFA;&#x7ACB;&#x6A21;&#x578B;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#x7684;&#x3002;</p>
<p><img src="images/activerecord/activerecord-associations.png" alt="activerecord-associations"></p>
<h3 id="association-&#x548C;&#x7EE7;&#x627F;&#x94FE;">Association &#x548C;&#x7EE7;&#x627F;&#x94FE;</h3>
<p>&#x9996;&#x5148;&#x6765;&#x770B; <code>.has_many</code> &#x65B9;&#x6CD5;&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; pry &#x76F4;&#x63A5;&#x627E;&#x5230;&#x8BE5;&#x65B9;&#x6CD5;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; $ User.has_many

<span class="hljs-symbol">From:</span> lib/active_record/associations.rb @ line <span class="hljs-number">1401</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Associations</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:ClassMethods</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_many</span><span class="hljs-params">(name, scope = <span class="hljs-keyword">nil</span>, options = {}, &amp;extension)</span></span>
  reflection = <span class="hljs-symbol">Builder:</span><span class="hljs-symbol">:HasMany</span>.build(<span class="hljs-keyword">self</span>, name, scope, options, &amp;extension)
  Reflection.add_reflection <span class="hljs-keyword">self</span>, name, reflection
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x6574;&#x4E2A; <code>.has_many</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x53EA;&#x6709;&#x4E24;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x603B;&#x5171;&#x6D89;&#x53CA;&#x4E24;&#x4E2A;&#x7C7B; <code>Builder::HasMany</code> &#x548C; <code>Reflection</code>&#xFF0C;&#x5176;&#x4E2D;&#x524D;&#x8005;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x65B0;&#x7684; <code>HasMany</code> &#x5173;&#x7CFB;&#xFF0C;&#x540E;&#x8005;&#x8D1F;&#x8D23;&#x5C06;&#x5173;&#x7CFB;&#x6DFB;&#x52A0;&#x5230;&#x5F53;&#x524D;&#x7C7B;&#x4E2D;&#x3002;</p>
<p><code>HasMany</code> &#x7C7B;&#x7684;&#x5B9E;&#x73B0;&#x5176;&#x5B9E;&#x975E;&#x5E38;&#x7B80;&#x5355;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x4ECE;&#x7236;&#x7C7B;&#x548C;&#x6574;&#x4E2A;&#x7EE7;&#x627F;&#x94FE;&#x4E2D;&#x7EE7;&#x627F;&#x4E86;&#x5F88;&#x591A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p><img src="images/activerecord/activerecord-hasmany-ancestors.png" alt="activerecord-hasmany-ancestors"></p>
<p>&#x6211;&#x4EEC;&#x6682;&#x65F6;&#x5148;&#x5FD8;&#x8BB0; <code>.has_many</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x7684;&#x4E24;&#x4E2A;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x7C7B;&#x90FD;&#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#xFF0C;&#x9996;&#x5148;&#x662F; <code>Association</code> &#x4EE5;&#x53CA;&#x5B83;&#x7684;&#x5B50;&#x7C7B;&#xFF1B;&#x5728; ActiveRecord &#x7684;&#x5B9E;&#x73B0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x80FD;&#x591F;&#x627E;&#x5230;&#x56DB;&#x79CD;&#x5173;&#x7CFB;&#x7684; Builder&#xFF0C;&#x5B83;&#x4EEC;&#x6709;&#x7740;&#x975E;&#x5E38;&#x6E05;&#x6670;&#x7B80;&#x5355;&#x7684;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#xFF1A;</p>
<p><img src="images/activerecord/activerecord-ancestor-builders.png" alt="activerecord-ancestor-builders"></p>
<p>&#x5728;&#x8FD9;&#x91CC;&#x5B9A;&#x4E49;&#x7684; <code>.build</code> &#x65B9;&#x6CD5;&#x5176;&#x5B9E;&#x5B9E;&#x73B0;&#x4E5F;&#x5F88;&#x6E05;&#x6670;&#xFF0C;&#x5B83;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x5F53;&#x524D;&#x62BD;&#x8C61;&#x7C7B; <code>Association</code> &#x6216;&#x8005;&#x5B50;&#x7C7B;&#x7684;&#x54CD;&#x5E94;&#x65B9;&#x6CD5;&#x5B8C;&#x6210;&#x4E00;&#x4E9B;&#x5EFA;&#x7ACB;&#x5173;&#x7CFB;&#x5FC5;&#x8981;&#x7684;&#x5DE5;&#x4F5C;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">build</span><span class="hljs-params">(model, name, scope, options, &amp;block)</span></span>
  extension = define_extensions model, name, &amp;block
  reflection = create_reflection model, name, scope, options, extension
  define_accessors model, reflection
  define_callbacks model, reflection
  define_validations model, reflection
  reflection
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5176;&#x4E2D;&#x5305;&#x62EC;&#x521B;&#x5EFA;&#x7528;&#x4E8E;&#x64CD;&#x4F5C;&#x3001;&#x67E5;&#x8BE2;&#x548C;&#x7BA1;&#x7406;&#x5F53;&#x524D;&#x5173;&#x7CFB;&#x6269;&#x5C55; Module &#x7684; <code>.define_extensions</code> &#x65B9;&#x6CD5;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x4F1A;&#x4F7F;&#x7528; <code>.create_reflection</code> &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x68C0;&#x67E5; ActiveRecord &#x7C7B;&#x7684;&#x5173;&#x7CFB;&#x7684; <code>Reflection</code> &#x5BF9;&#x8C61;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x4E0B;&#x4E00;&#x8282;&#x4E2D;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD;&#xFF0C;&#x5728;&#x521B;&#x5EFA;&#x4E86; <code>Reflection</code> &#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x6839;&#x636E;&#x4F20;&#x5165;&#x7684;&#x6A21;&#x578B;&#x548C; <code>Reflection</code> &#x5BF9;&#x8C61;&#x4E3A;&#x5F53;&#x524D;&#x7684;&#x7C7B;&#xFF0C;&#x4F8B;&#x5982; <code>User</code> &#x5B9A;&#x4E49;&#x5C5E;&#x6027;&#x5B58;&#x53D6;&#x65B9;&#x6CD5;&#x3001;&#x56DE;&#x8C03;&#x4EE5;&#x53CA;&#x9A8C;&#x8BC1;:</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">define_accessors</span><span class="hljs-params">(model, reflection)</span></span>
  mixin = model.generated_association_methods
  name = reflection.name
  define_readers(mixin, name)
  define_writers(mixin, name)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">define_readers</span><span class="hljs-params">(mixin, name)</span></span>
  mixin.class_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-comment">#{name}(*args)</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).reader(*args)</span>
    <span class="hljs-keyword">end</span>
  CODE
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">define_writers</span><span class="hljs-params">(mixin, name)</span></span>
  mixin.class_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-comment">#{name}=(value)</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).writer(value)</span>
    <span class="hljs-keyword">end</span>
  CODE
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5B58;&#x53D6;&#x65B9;&#x6CD5;&#x8FD8;&#x662F;&#x901A;&#x8FC7; Ruby &#x7684;&#x5143;&#x7F16;&#x7A0B;&#x80FD;&#x529B;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x901A;&#x8FC7; <code>.class_eval</code> &#x65B9;&#x6CD5;&#x975E;&#x5E38;&#x8F7B;&#x677E;&#x5730;&#x5C31;&#x80FD;&#x5728;&#x5F53;&#x524D;&#x7684;&#x6A21;&#x578B;&#x4E2D;&#x5B9A;&#x4E49;&#x65B9;&#x6CD5;&#xFF0C;&#x5173;&#x4E8E;&#x56DE;&#x8C03;&#x548C;&#x9A8C;&#x8BC1;&#x7684;&#x5B9A;&#x4E49;&#x5728;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x5728;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD;&#x4E86;&#x3002;</p>
<h3 id="reflection-&#x548C;&#x7EE7;&#x627F;&#x94FE;">Reflection &#x548C;&#x7EE7;&#x627F;&#x94FE;</h3>
<p><code>Reflection</code> &#x542F;&#x7528;&#x4E86;&#x68C0;&#x67E5; ActiveRecord &#x7C7B;&#x548C;&#x5BF9;&#x8C61;&#x7684;&#x5173;&#x7CFB;&#x548C;&#x805A;&#x5408;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5B83;&#x80FD;&#x591F;&#x5728; Builder &#x4E2D;&#x4F7F;&#x7528;&#x4E3A; ActiveRecord &#x4E2D;&#x7684;&#x7C7B;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x5C5E;&#x6027;&#x548C;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4E0E; <code>Association</code> &#x4E00;&#x6837;&#xFF0C;ActiveRecord &#x4E2D;&#x7684;&#x4E0D;&#x540C;&#x5173;&#x7CFB;&#x4E5F;&#x6709;&#x4E0D;&#x540C;&#x7684; <code>Reflection</code>&#xFF0C;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x5173;&#x7CFB;&#x548C;&#x4E0D;&#x540C;&#x7684;&#x914D;&#x7F6E;&#xFF0C;ActiveRecord &#x4E2D;&#x5EFA;&#x7ACB;&#x4E86;&#x4E00;&#x5957; Reflection &#x7684;&#x7EE7;&#x627F;&#x4F53;&#x7CFB;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x4E0D;&#x540C;&#x5173;&#x7CFB;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#xFF1A;</p>
<p><img src="images/activerecord/activerecord-reflections.png" alt="activerecord-reflections"></p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x5728;&#x4E0A;&#x9762;&#x4F7F;&#x7528; <code>.has_many</code> &#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7; <code>.create_reflection</code> &#x521B;&#x5EFA;&#x4E00;&#x4E2A; <code>HasManyReflection</code> &#x5BF9;&#x8C61;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">create_reflection</span><span class="hljs-params">(model, name, scope, options, extension = <span class="hljs-keyword">nil</span>)</span></span>
  <span class="hljs-keyword">if</span> scope.is_a?(Hash)
    options = scope
    scope   = <span class="hljs-keyword">nil</span>
  <span class="hljs-keyword">end</span>

  validate_options(options)
  scope = build_scope(scope, extension)
  <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Reflection</span>.create(macro, name, scope, options, model)
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>Reflection#create</code> &#x65B9;&#x6CD5;&#x662F;&#x4E00;&#x4E2A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x4F1A;&#x6839;&#x636E;&#x4F20;&#x5165;&#x7684; <code>macro</code> &#x548C; <code>options</code> &#x4E2D;&#x7684;&#x503C;&#x9009;&#x62E9;&#x5408;&#x9002;&#x7684;&#x7C7B;&#x5B9E;&#x4F8B;&#x5316;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">create</span><span class="hljs-params">(macro, name, scope, options, ar)</span></span>
  klass = \
    <span class="hljs-keyword">case</span> macro
    <span class="hljs-keyword">when</span> <span class="hljs-symbol">:composed_of</span>
      AggregateReflection
    <span class="hljs-keyword">when</span> <span class="hljs-symbol">:has_many</span>
      HasManyReflection
    <span class="hljs-keyword">when</span> <span class="hljs-symbol">:has_one</span>
      HasOneReflection
    <span class="hljs-keyword">when</span> <span class="hljs-symbol">:belongs_to</span>
      BelongsToReflection
    <span class="hljs-keyword">else</span>
      raise <span class="hljs-string">&quot;Unsupported Macro: <span class="hljs-subst">#{macro}</span>&quot;</span>
    <span class="hljs-keyword">end</span>

  reflection = klass.new(name, scope, options, ar)
  options[<span class="hljs-symbol">:through</span>] ? ThroughReflection.new(reflection) <span class="hljs-symbol">:</span> reflection
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x521B;&#x5EFA;&#x7684; <code>Reflection</code> &#x5728;&#x5F88;&#x591A;&#x65F6;&#x5019;&#x90FD;&#x6709;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x5728;&#x521B;&#x5EFA;&#x5B58;&#x50A8;&#x65B9;&#x6CD5;&#x3001;&#x56DE;&#x8C03;&#x548C;&#x9A8C;&#x8BC1;&#x65F6;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x5C06;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x5165;&#x63D0;&#x4F9B;&#x4E00;&#x5B9A;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x8D77;&#x5230;&#x4E86;&#x6570;&#x636E;&#x6E90;&#x548C;&#x63D0;&#x4F9B; Helper &#x65B9;&#x6CD5;&#x7684;&#x4F5C;&#x7528;&#x3002;</p>
<p>&#x5728;&#x6574;&#x4E2A;&#x5B9A;&#x4E49;&#x65B9;&#x6CD5;&#x3001;&#x5C5E;&#x6027;&#x4EE5;&#x53CA;&#x56DE;&#x8C03;&#x7684;&#x5DE5;&#x4F5C;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x5C06;&#x5F53;&#x524D;&#x7684;&#x5BF9;&#x8C61;&#x4EE5; <code>name</code> &#x4F5C;&#x4E3A;&#x952E;&#x5B58;&#x50A8;&#x5230;&#x81EA;&#x5DF1;&#x6301;&#x6709;&#x7684;&#x4E00;&#x4E2A; <code>_reflections</code> &#x5B57;&#x5178;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-comment"># class_attribute :_reflections, instance_writer: false</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">add_reflection</span><span class="hljs-params">(ar, name, reflection)</span></span>
  ar.clear_reflections_cache
  ar._reflections = ar._reflections.merge(name.to_s =&gt; reflection)
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x5B57;&#x5178;&#x4E2D;&#x5B58;&#x50A8;&#x7740;&#x6240;&#x6709;&#x5728;&#x5F53;&#x524D;&#x7C7B;&#x4E2D;&#x4F7F;&#x7528; <code>has_many</code>&#x3001;<code>has_one</code>&#x3001;<code>belongs_to</code> &#x7B49;&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x7684;&#x5173;&#x7CFB;&#x5BF9;&#x5E94;&#x7684;&#x6620;&#x5C04;&#x3002;</p>
<h3 id="&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;">&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;</h3>
<p>&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x7684;&#x8FD9;&#x4E00;&#x8282;&#x4F1A;&#x5206;&#x522B;&#x4ECB;&#x7ECD;&#x4E24;&#x4E2A;&#x6781;&#x5176;&#x91CD;&#x8981;&#x7684;&#x65B9;&#x6CD5; <code>.has_many</code> &#x548C; <code>.belongs_to</code> &#x7684;&#x5B9E;&#x73B0;&#xFF1B;&#x5728;&#x8FD9;&#x91CC;&#xFF0C;&#x4F1A;&#x5148;&#x901A;&#x8FC7; <code>.has_many</code> &#x5173;&#x7CFB;&#x4E86;&#x89E3;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x8986;&#x5199;&#x7236;&#x7C7B;&#x65B9;&#x6CD5;&#x5B9A;&#x5236;&#x81EA;&#x5DF1;&#x7684;&#x7279;&#x6027;&#x7684;&#xFF0C;&#x4E4B;&#x540E;&#x4F1A;&#x901A;&#x8FC7; <code>.belongs_to</code> &#x7814;&#x7A76; getter/setter &#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;</p>
<p><img src="images/activerecord/one-to-many-association.png" alt="one-to-many-association"></p>
<p>&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x5728;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6A21;&#x578B;&#x4E4B;&#x95F4;&#x975E;&#x5E38;&#x5E38;&#x89C1;&#xFF0C;&#x800C;&#x8FD9;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x5728; ActiveRecord &#x4E5F;&#x7ECF;&#x5E38;&#x6210;&#x5BF9;&#x51FA;&#x73B0;&#x3002;</p>
<h4 id="hasmany">has_many</h4>
<p>&#x5F53;&#x6211;&#x4EEC;&#x5BF9;&#x6784;&#x5EFA;&#x5173;&#x7CFB;&#x6A21;&#x5757;&#x7684;&#x4E24;&#x5927;&#x652F;&#x67F1;&#x90FD;&#x5DF2;&#x7ECF;&#x6709;&#x6240;&#x4E86;&#x89E3;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x6765;&#x770B;&#x8FD9;&#x51E0;&#x4E2A;&#x5E38;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x5C31;&#x6CA1;&#x6709;&#x592A;&#x591A;&#x7684;&#x96BE;&#x5EA6;&#x4E86;&#xFF0C;&#x9996;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x4E2D;&#x7684;&#x300E;&#x591A;&#x300F;&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_many</span><span class="hljs-params">(name, scope = <span class="hljs-keyword">nil</span>, options = {}, &amp;extension)</span></span>
  reflection = <span class="hljs-symbol">Builder:</span><span class="hljs-symbol">:HasMany</span>.build(<span class="hljs-keyword">self</span>, name, scope, options, &amp;extension)
  Reflection.add_reflection <span class="hljs-keyword">self</span>, name, reflection
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x7531;&#x4E8E;&#x5DF2;&#x7ECF;&#x5BF9; <code>Reflection.add_reflection</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x6709;&#x6240;&#x4E86;&#x89E3;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x770B; <code>.has_many</code> &#x8C03;&#x7528;&#x7684; <code>Builder::HasMany.build</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x7C7B;&#x65B9;&#x6CD5;&#x7A76;&#x7ADF;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">build</span><span class="hljs-params">(model, name, scope, options, &amp;block)</span></span>
  extension = define_extensions model, name, &amp;block
  reflection = create_reflection model, name, scope, options, extension
  define_accessors model, reflection
  define_callbacks model, reflection
  define_validations model, reflection
  reflection
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x8FD9;&#x91CC;&#x6267;&#x884C;&#x7684; <code>.build</code> &#x65B9;&#x6CD5;&#x4E0E;&#x62BD;&#x8C61;&#x7C7B;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;&#x5B8C;&#x5168;&#x76F8;&#x540C;&#xFF0C;&#x5B50;&#x7C7B;&#x5E76;&#x6CA1;&#x6709;&#x8986;&#x76D6;&#x7236;&#x7C7B;&#x5B9E;&#x73B0;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x627E;&#x4E00;&#x4E0B; <code>.define_accessors</code>&#x3001;<code>.define_callbacks</code> &#x548C; <code>.define_validations</code> &#x4E09;&#x4E2A;&#x65B9;&#x6CD5;&#x5728; has_many &#x5173;&#x7CFB;&#x4E2D;&#x90FD;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#x3002;</p>
<p><code>HasMany</code> &#x4F5C;&#x4E3A; has_many &#x5173;&#x7CFB;&#x7684; Builder &#x7C7B;&#xFF0C;&#x5176;&#x672C;&#x8EAB;&#x5E76;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;&#x592A;&#x591A;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53EA;&#x662F;&#x5BF9;&#x4E00;&#x4E9B;&#x5173;&#x7CFB;&#x9009;&#x9879;&#x6709;&#x4E00;&#x4E9B;&#x81EA;&#x5DF1;&#x72EC;&#x6709;&#x7684;&#x58F0;&#x660E;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ActiveRecord::Associations::Builder</span></span>
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HasMany</span> &lt; CollectionAssociation</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">macro</span></span>
      <span class="hljs-symbol">:has_many</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">valid_options</span><span class="hljs-params">(options)</span></span>
      <span class="hljs-keyword">super</span> + [<span class="hljs-symbol">:primary_key</span>, <span class="hljs-symbol">:dependent</span>, <span class="hljs-symbol">:as</span>, <span class="hljs-symbol">:through</span>, <span class="hljs-symbol">:source</span>, <span class="hljs-symbol">:source_type</span>, <span class="hljs-symbol">:inverse_of</span>, <span class="hljs-symbol">:counter_cache</span>, <span class="hljs-symbol">:join_table</span>, <span class="hljs-symbol">:foreign_type</span>, <span class="hljs-symbol">:index_errors</span>]
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">valid_dependent_options</span></span>
      [<span class="hljs-symbol">:destroy</span>, <span class="hljs-symbol">:delete_all</span>, <span class="hljs-symbol">:nullify</span>, <span class="hljs-symbol">:restrict_with_error</span>, <span class="hljs-symbol">:restrict_with_exception</span>]
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x7531;&#x4E8E;&#x672C;&#x8EAB; has_many &#x5173;&#x7CFB;&#x4E2D;&#x7684;&#x8BFB;&#x5199;&#x65B9;&#x6CD5;&#x90FD;&#x662F;&#x5BF9;&#x96C6;&#x5408;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x9996;&#x5148;&#x8986;&#x5199;&#x4E86; <code>.define_writers</code> &#x548C; <code>.define_readers</code> &#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x751F;&#x6210;&#x4E86;&#x53E6;&#x5916;&#x4E00;&#x7EC4;&#x64CD;&#x4F5C; id &#x7684; getter/setter &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">define_readers</span><span class="hljs-params">(mixin, name)</span></span>
  <span class="hljs-keyword">super</span>

  mixin.class_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-comment">#{name.to_s.singularize}_ids</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).ids_reader</span>
    <span class="hljs-keyword">end</span>
  CODE
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">define_writers</span><span class="hljs-params">(mixin, name)</span></span>
  <span class="hljs-keyword">super</span>

  mixin.class_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-comment">#{name.to_s.singularize}_ids=(ids)</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).ids_writer(ids)</span>
    <span class="hljs-keyword">end</span>
  CODE
<span class="hljs-keyword">end</span>
</code></pre>
<p>has_many &#x5173;&#x7CFB;&#x5728; <code>CollectionAssociation</code> &#x548C; <code>HasManyAssociation</code> &#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x51E0;&#x4E2A;&#x65B9;&#x6CD5; <code>#reader</code>&#x3001;<code>#writer</code>&#x3001;<code>#ids_reader</code> &#x548C; <code>#ids_writer</code> &#x5176;&#x5B9E;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x7684;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x5C31;&#x8DF3;&#x8FC7;&#x4E0D;&#x8C08;&#x4E86;&#x3002;</p>
<p>&#x800C; <code>.define_callbacks</code> &#x548C; <code>.define_extensions</code> &#x5176;&#x5B9E;&#x90FD;&#x5927;&#x540C;&#x5C0F;&#x5F02;&#xFF0C;&#x5728;&#x4F5C;&#x8005;&#x770B;&#x6765;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x503C;&#x5F97;&#x8BB2;&#x7684;&#xFF0C;has_many &#x4E2D;&#x6700;&#x91CD;&#x8981;&#x7684;&#x90E8;&#x5206;&#x8FD8;&#x662F;&#x8BFB;&#x5199;&#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x8FC7;&#x7A0B;&#xFF0C;&#x4E0D;&#x8FC7;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x6240;&#x9650;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x591A;&#x8BF4;&#x4E86;&#x3002;</p>
<h4 id="belongsto">belongs_to</h4>
<p>&#x5728;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x4E2D;&#xFF0C;&#x7ECF;&#x5E38;&#x4E0E; has_many &#x5BF9;&#x5E94;&#x7684;&#x5173;&#x7CFB; belongs_to &#x5176;&#x5B9E;&#x5B9E;&#x73B0;&#x548C;&#x8C03;&#x7528;&#x6808;&#x4E5F;&#x51E0;&#x4E4E;&#x5B8C;&#x5168;&#x76F8;&#x540C;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">belongs_to</span><span class="hljs-params">(name, scope = <span class="hljs-keyword">nil</span>, options = {})</span></span>
  reflection = <span class="hljs-symbol">Builder:</span><span class="hljs-symbol">:BelongsTo</span>.build(<span class="hljs-keyword">self</span>, name, scope, options)
  Reflection.add_reflection <span class="hljs-keyword">self</span>, name, reflection
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x4F46;&#x662F;&#x4E0E; has_many &#x6BD4;&#x8F83;&#x5927;&#x7684;&#x4E0D;&#x540C;&#x662F; <code>Builder::BelongsTo</code> &#x901A;&#x8FC7;&#x7EE7;&#x627F;&#x7684;&#x7236;&#x7C7B;&#x5B9A;&#x4E49;&#x4E86;&#x5F88;&#x591A;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x65B0;&#x5173;&#x7CFB;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">define_accessors</span><span class="hljs-params">(model, reflection)</span></span>
  <span class="hljs-keyword">super</span>
  mixin = model.generated_association_methods
  name = reflection.name
  define_constructors(mixin, name) <span class="hljs-keyword">if</span> reflection.constructable?
  mixin.class_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reload_</span><span class="hljs-comment">#{name}</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).force_reload_reader</span>
    <span class="hljs-keyword">end</span>
  CODE
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">define_constructors</span><span class="hljs-params">(mixin, name)</span></span>
  mixin.class_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build_</span><span class="hljs-comment">#{name}(*args, &amp;block)</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).build(*args, &amp;block)</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_</span><span class="hljs-comment">#{name}(*args, &amp;block)</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).create(*args, &amp;block)</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_</span><span class="hljs-comment">#{name}!(*args, &amp;block)</span></span>
      association(<span class="hljs-symbol">:</span><span class="hljs-comment">#{name}).create!(*args, &amp;block)</span>
    <span class="hljs-keyword">end</span>
  CODE
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5176;&#x4ED6;&#x7684;&#x90E8;&#x5206;&#x867D;&#x7136;&#x5B9E;&#x73B0;&#x4E0A;&#x4E5F;&#x4E0E; has_many &#x6709;&#x7740;&#x975E;&#x5E38;&#x5927;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x662F;&#x539F;&#x7406;&#x57FA;&#x672C;&#x4E0A;&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#xFF0C;&#x4E0D;&#x8FC7;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6765;&#x770B;&#x4E00;&#x4E0B; belongs_to &#x5173;&#x7CFB;&#x521B;&#x5EFA;&#x7684;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5; <code>association</code> &#x548C; <code>association=</code> &#x7A76;&#x7ADF;&#x662F;&#x5982;&#x4F55;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x7684;&#x3002;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Topic</span> &lt; ActiveRecord::Base</span>
  has_many <span class="hljs-symbol">:subtopics</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Subtopic</span> &lt; ActiveRecord::Base</span>
  belongs_to <span class="hljs-symbol">:topic</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x6709;&#x7740;&#x5982;&#x4E0A;&#x6240;&#x793A;&#x7684;&#x4E24;&#x4E2A;&#x6A21;&#x578B;&#xFF0C;&#x5B83;&#x4EEC;&#x4E4B;&#x95F4;&#x662F;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x6211;&#x4EEC;&#x4EE5;&#x8FD9;&#x5BF9;&#x6A21;&#x578B;&#x4E3A;&#x4F8B;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B; <code>association</code> &#x8FD9;&#x4E2A;&#x8BFB;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;</p>
<p><img src="images/activerecord/callstack-for-belongs-to-association-getter.png" alt="callstack-for-belongs-to-association-gette"></p>
<p>&#x901A;&#x8FC7;&#x6211;&#x4EEC;&#x5BF9;&#x6E90;&#x4EE3;&#x7801;&#x548C;&#x8C03;&#x7528;&#x6808;&#x7684;&#x9605;&#x8BFB;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5176;&#x5B9E;&#x5982;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x5728;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#x662F;&#x5B8C;&#x5168;&#x7B49;&#x4EF7;&#x7684;&#xFF0C;&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x6301;&#x6709;&#x4E86;&#x4E00;&#x4E2A; <code>Subtopic</code> &#x5BF9;&#x8C61;&#xFF1A;</p>
<pre><code class="lang-ruby">subtopic = Subtopic.first <span class="hljs-comment">#=&gt; #&lt;Subtopic:0x007ff513f67768&gt;</span>

subtopic.topic
subtopic.association(<span class="hljs-symbol">:topic</span>).reader
subtopic.association(<span class="hljs-symbol">:topic</span>).target
subtopic.association(<span class="hljs-symbol">:topic</span>).load_target
subtopic.association(<span class="hljs-symbol">:topic</span>).send(<span class="hljs-symbol">:find_target</span>)
</code></pre>
<p>&#x4E0A;&#x8FF0;&#x7684;&#x4E94;&#x79CD;&#x65B9;&#x5F0F;&#x90FD;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x5F53;&#x524D; <code>Subtopic</code> &#x5BF9;&#x8C61;&#x7684; belongs_to &#x5173;&#x7CFB;&#x5BF9;&#x5E94;&#x7684; <code>Topic</code> &#x6570;&#x636E;&#x884C;&#xFF0C;&#x800C;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5; <code>#find_target</code> &#x5176;&#x5B9E;&#x4E5F;&#x5C31;&#x662F;&#x771F;&#x6B63;&#x521B;&#x5EFA;&#x3001;&#x7ED1;&#x5B9A;&#x5230;&#x6700;&#x540E;&#x6267;&#x884C;&#x67E5;&#x8BE2; SQL &#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby">pry(main)&gt; $ subtopic.association(<span class="hljs-symbol">:topic</span>).find_target

<span class="hljs-symbol">From:</span> lib/active_record/associations/singular_association.rb @ line <span class="hljs-number">38</span><span class="hljs-symbol">:</span>
<span class="hljs-symbol">Owner:</span> <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Associations</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:SingularAssociation</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_target</span></span>
  <span class="hljs-keyword">return</span> scope.take <span class="hljs-keyword">if</span> skip_statement_cache?

  conn = klass.connection
  sc = reflection.association_scope_cache(conn, owner) <span class="hljs-keyword">do</span>
    StatementCache.create(conn) { |params|
      as = AssociationScope.create { params.bind }
      target_scope.merge(as.scope(<span class="hljs-keyword">self</span>, conn)).limit(<span class="hljs-number">1</span>)
    }
  <span class="hljs-keyword">end</span>

  binds = AssociationScope.get_bind_values(owner, reflection.chain)
  sc.execute(binds, klass, conn) <span class="hljs-keyword">do</span> |record|
    set_inverse_instance record
  <span class="hljs-keyword">end</span>.first
<span class="hljs-keyword">rescue</span> <span class="hljs-symbol">:</span><span class="hljs-symbol">:RangeError</span>
  <span class="hljs-keyword">nil</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5BF9; <code>association</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x6709;&#x4E86;&#x975E;&#x5E38;&#x6E05;&#x695A;&#x7684;&#x8BA4;&#x77E5;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x518D;&#x6765;&#x8FC7;&#x4E00;&#x4E0B; <code>association=</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x9996;&#x5148;&#x8FD8;&#x662F;&#x6765;&#x770B;&#x4E00;&#x4E0B; setter &#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF1A;</p>
<p><img src="images/activerecord/callstack-for-belongs-to-association-setter.png" alt="callstack-for-belongs-to-association-sette"></p>
<p>&#x76F8;&#x6BD4;&#x4E8E; getter &#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;setter &#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x6808;&#x90FD;&#x590D;&#x6742;&#x4E86;&#x5F88;&#x591A;&#xFF0C;&#x5728;&#x7814;&#x7A76; setter &#x65B9;&#x6CD5;&#x5B9E;&#x73B0;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x6211;&#x4EEC;&#x4E00;&#x5B9A;&#x8981;&#x8BB0;&#x4F4F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5E76;&#x4E0D;&#x4F1A;&#x6539;&#x53D8;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x884C;&#xFF0C;&#x53EA;&#x4F1A;&#x6539;&#x53D8;&#x5F53;&#x524D;&#x5BF9;&#x5E94;&#x7684;&#x67D0;&#x4E2A;&#x5C5E;&#x6027;&#xFF0C;&#x7ECF;&#x8FC7;&#x5BF9;&#x8C03;&#x7528;&#x6808;&#x548C;&#x6E90;&#x4EE3;&#x7801;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6709;&#x4EE5;&#x4E0B;&#x7684;&#x7ED3;&#x8BBA;&#xFF1A;&#x5047;&#x8BBE;&#x73B0;&#x5728;&#x6709;&#x4E00;&#x4E2A; <code>Subtopic</code> &#x5BF9;&#x8C61;&#x548C;&#x4E00;&#x4E2A;&#x65B0;&#x7684; <code>Topic</code> &#x5B9E;&#x4F8B;&#xFF0C;&#x90A3;&#x4E48;&#x4E0B;&#x9762;&#x7684;&#x4E00;&#x7CFB;&#x5217;&#x64CD;&#x4F5C;&#x5176;&#x5B9E;&#x662F;&#x5B8C;&#x5168;&#x76F8;&#x540C;&#x7684;&#xFF1A;</p>
<pre><code class="lang-ruby">subtopic = Subtopic.first <span class="hljs-comment">#=&gt; #&lt;Subtopic:0x007ff513f67768&gt;</span>
new_topic = Topic.first   <span class="hljs-comment">#=&gt; #&lt;Topic:0x007ff514b24cb8&gt;</span>

subtopic.topic = new_topic
subtopic.topic_id = new_topic.id
subtopic.association(<span class="hljs-symbol">:topic</span>).writer(new_topic)
subtopic.association(<span class="hljs-symbol">:topic</span>).replace(new_topic)
subtopic.association(<span class="hljs-symbol">:topic</span>).replace_keys(new_topic)
subtopic.association(<span class="hljs-symbol">:topic</span>).owner[<span class="hljs-symbol">:topic_id</span>] = new_topic.id
subtopic[<span class="hljs-symbol">:topic_id</span>] = new_topic.id
subtopic.write_attribute(<span class="hljs-symbol">:topic_id</span>, new_topic.id)
</code></pre>
<p>&#x867D;&#x7136;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x6700;&#x540E;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#x53EF;&#x80FD;&#x6709;&#x6240;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x4EEC;&#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x5C06; <code>subtopic</code> &#x5BF9;&#x8C61;&#x7684; <code>topic_id</code> &#x5C5E;&#x6027;&#x66F4;&#x65B0;&#x6210; <code>topic.id</code>&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x6709;&#x7B80;&#x5355;&#x7684;&#xFF0C;&#x4E5F;&#x6709;&#x590D;&#x6742;&#x7684;&#xFF0C;&#x4E0D;&#x8FC7;&#x90FD;&#x80FD;&#x8FBE;&#x5230;&#x76F8;&#x540C;&#x7684;&#x76EE;&#x7684;&#xFF1B;&#x6211;&#x76F8;&#x4FE1;&#x5982;&#x679C;&#x8BFB;&#x8005;&#x4EB2;&#x624B;&#x521B;&#x5EFA;&#x4E0A;&#x8FF0;&#x7684;&#x5173;&#x7CFB;&#x5E76;&#x4F7F;&#x7528; pry &#x67E5;&#x770B;&#x6E90;&#x4EE3;&#x7801;&#x4E00;&#x5B9A;&#x4F1A;&#x5BF9; getter &#x548C; setter &#x7684;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x6709;&#x7740;&#x975E;&#x5E38;&#x6E05;&#x695A;&#x7684;&#x8BA4;&#x8BC6;&#x3002;</p>
<h3 id="&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;-habtm">&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB; habtm</h3>
<p>&#x65E0;&#x8BBA;&#x662F; has_many &#x8FD8;&#x662F; belongs_to &#x5176;&#x5B9E;&#x90FD;&#x662F;&#x4E00;&#x4E2A; ORM &#x539F;&#x751F;&#x9700;&#x8981;&#x652F;&#x6301;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4F46;&#x662F; habtm(has_and_belongs_to_many) &#x5374;&#x662F; ActiveRecord &#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x65B9;&#x4FBF;&#x7684;&#x8BED;&#x6CD5;&#x7CD6;&#xFF0C;&#x54EA;&#x6015;&#x662F;&#x5E76;&#x6CA1;&#x6709; <code>.has_and_belongs_to_many</code> &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x80FD;&#x901A;&#x8FC7; <code>.has_many</code> &#x5B9E;&#x73B0;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x5F97;&#x5230;&#x4E0E;&#x524D;&#x8005;&#x5B8C;&#x5168;&#x7B49;&#x4EF7;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x53EA;&#x662F;&#x5B9E;&#x73B0;&#x7684;&#x8FC7;&#x7A0B;&#x7A0D;&#x5FAE;&#x9EBB;&#x70E6;&#x4E00;&#x4E9B;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x5C0F;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x4E86;&#x89E3; habtm &#x8FD9;&#x4E2A;&#x8BED;&#x6CD5;&#x7CD6;&#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#xFF0C;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x5C06;&#x73B0;&#x6709;&#x7684;&#x5173;&#x7CFB;&#x7EC4;&#x6210;&#x66F4;&#x590D;&#x6742;&#x7684; habtm &#x7684;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x7684;&#xFF1B;&#x60F3;&#x8981;&#x4E86;&#x89E3;&#x5B83;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x81EA;&#x7136;&#x8981;&#x5206;&#x6790;&#x5B83;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_and_belongs_to_many</span><span class="hljs-params">(name, scope = <span class="hljs-keyword">nil</span>, **options, &amp;extension)</span></span>
  builder = <span class="hljs-symbol">Builder:</span><span class="hljs-symbol">:HasAndBelongsToMany</span>.new name, <span class="hljs-keyword">self</span>, options
  join_model = <span class="hljs-symbol">ActiveSupport:</span><span class="hljs-symbol">:Deprecation</span>.silence { builder.through_model }
  const_set join_model.name, join_model
  private_constant join_model.name

  habtm_reflection = <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Reflection</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:HasAndBelongsToManyReflection</span>.new(name, scope, options, <span class="hljs-keyword">self</span>)
  middle_reflection = builder.middle_reflection join_model
  <span class="hljs-symbol">Builder:</span><span class="hljs-symbol">:HasMany</span>.define_callbacks <span class="hljs-keyword">self</span>, middle_reflection
  Reflection.add_reflection <span class="hljs-keyword">self</span>, middle_reflection.name, middle_reflection
  middle_reflection.parent_reflection = habtm_reflection

  <span class="hljs-comment"># ...</span>

  hm_options = {}
  hm_options[<span class="hljs-symbol">:through</span>] = middle_reflection.name
  hm_options[<span class="hljs-symbol">:source</span>] = join_model.right_reflection.name

  <span class="hljs-comment"># ...</span>

  <span class="hljs-symbol">ActiveSupport:</span><span class="hljs-symbol">:Deprecation</span>.silence { has_many name, scope, hm_options, &amp;extension }
  _reflections[name.to_s].parent_reflection = habtm_reflection
<span class="hljs-keyword">end</span>
</code></pre>
<blockquote>
<p>&#x5728;&#x8FD9;&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x8BE5;&#x65B9;&#x6CD5;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#x91CD;&#x65B0;&#x8FDB;&#x884C;&#x7EC4;&#x7EC7;&#x548C;&#x6392;&#x5E8F;&#xFF0C;&#x65B9;&#x6CD5;&#x7684;&#x4F5C;&#x7528;&#x4E0E; v5.1.4 &#x4E2D;&#x7684;&#x5B8C;&#x5168;&#x76F8;&#x540C;&#x3002;</p>
</blockquote>
<p>&#x4E0A;&#x8FF0;&#x65B9;&#x6CD5;&#x5728;&#x6700;&#x5F00;&#x59CB;&#x5148;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; <code>HasAndBelongsToMany</code> &#x7684; Builder &#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x5728; block &#x4E2D;&#x6267;&#x884C;&#x4E86;&#x8FD9;&#x4E2A; Builder &#x7684; <code>#through_model</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">through_model</span></span>
  habtm = JoinTableResolver.build lhs_model, association_name, options

  join_model = Class.new(<span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Base</span>) {
    <span class="hljs-class"><span class="hljs-keyword">class</span> &lt;&lt; self;</span>
      <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:left_model</span>
      <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:name</span>
      <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:table_name_resolver</span>
      <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:left_reflection</span>
      <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:right_reflection</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># ...</span>
  }

  join_model.name                = <span class="hljs-string">&quot;HABTM_<span class="hljs-subst">#{association_name.to_s.camelize}</span>&quot;</span>
  join_model.table_name_resolver = habtm
  join_model.left_model          = lhs_model
  join_model.add_left_association <span class="hljs-symbol">:left_side</span>, <span class="hljs-symbol">anonymous_class:</span> lhs_model
  join_model.add_right_association association_name, belongs_to_options(options)
  join_model
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>#through_model</code> &#x65B9;&#x6CD5;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7EE7;&#x627F;&#x81EA; <code>ActiveRecord::Base</code> &#x7684;&#x7C7B;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x4E00;&#x4E0B;&#x7684;&#x4F8B;&#x5B50;&#x6765;&#x8BF4;&#x660E;&#x4E00;&#x4E0B;&#x8FD9;&#x91CC;&#x7A76;&#x7ADF;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#x5047;&#x8BBE;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x5DE5;&#x7A0B;&#x4E2D;&#x5B9A;&#x4E49;&#x4E86;&#x5982;&#x4E0B;&#x7684;&#x4E24;&#x4E2A;&#x7C7B;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> &lt; ActiveRecord::Base</span>
  has_and_belongs_to_many <span class="hljs-symbol">:tags</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tag</span> &lt; ActiveRecord::Base</span>
  has_and_belongs_to_many <span class="hljs-symbol">:posts</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5B83;&#x4EEC;&#x6BCF;&#x4E2A;&#x7C7B;&#x90FD;&#x901A;&#x8FC7; <code>.has_and_belongs_to_many</code> &#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; <code>join_model</code> &#x7C7B;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x90FD;&#x662F;&#x5728;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x4E0B;&#x7684;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post::HABTM_Posts</span> &lt; ActiveRecord::Base;</span> <span class="hljs-keyword">end</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tags::HABTM_Posts</span> &lt; ActiveRecord::Base;</span> <span class="hljs-keyword">end</span>
</code></pre>
<p>&#x9664;&#x4E86;&#x5728;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x4E0B;&#x5B9A;&#x4E49;&#x4E24;&#x4E2A;&#x65B0;&#x7684;&#x7C7B;&#x4E4B;&#x5916;&#xFF0C;<code>#through_model</code> &#x65B9;&#x6CD5;&#x8FD8;&#x901A;&#x8FC7; <code>#add_left_association</code> &#x548C; <code>#add_right_association</code> &#x4E3A;&#x521B;&#x5EFA;&#x7684;&#x79C1;&#x6709;&#x7C7B;&#x6DFB;&#x52A0;&#x4E86;&#x4E24;&#x4E2A; <code>.belongs_to</code> &#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#xFF1A;</p>
<pre><code class="lang-ruby">join_model = Class.new(<span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Base</span>) {
  <span class="hljs-comment"># ...</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">add_left_association</span><span class="hljs-params">(name, options)</span></span>
    belongs_to name, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">false</span>, **options
    <span class="hljs-keyword">self</span>.left_reflection = _reflect_on_association(name)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">add_right_association</span><span class="hljs-params">(name, options)</span></span>
    rhs_name = name.to_s.singularize.to_sym
    belongs_to rhs_name, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">false</span>, **options
    <span class="hljs-keyword">self</span>.right_reflection = _reflect_on_association(rhs_name)
  <span class="hljs-keyword">end</span>
}
</code></pre>
<p>&#x6240;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; HABTM &#x7C7B;&#x4E2D;&#x90FD;&#x901A;&#x8FC7; <code>.belongs_to</code> &#x589E;&#x52A0;&#x4E86;&#x4E24;&#x4E2A;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x8868;&#x4E2D;&#x5BF9;&#x5E94;&#x5217;&#x7684;&#x6620;&#x5C04;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post::HABTM_Posts</span> &lt; ActiveRecord::Base</span>
  belongs_to <span class="hljs-symbol">:post_id</span>, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">false</span>
  belongs_to <span class="hljs-symbol">:tag_id</span>, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">false</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tags::HABTM_Posts</span> &lt; ActiveRecord::Base</span>
  belongs_to <span class="hljs-symbol">:tag_id</span>, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">false</span>
  belongs_to <span class="hljs-symbol">:post_id</span>, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">false</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x770B;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x4F60;&#x53EF;&#x80FD;&#x4F1A;&#x8BA4;&#x4E3A;&#x65E2;&#x7136;&#x6709;&#x4E24;&#x4E2A;&#x6A21;&#x578B;&#xFF0C;&#x90A3;&#x4E48;&#x5E94;&#x8BE5;&#x4F1A;&#x6709;&#x4E24;&#x5F20;&#x8868;&#x5206;&#x522B;&#x5BF9;&#x5E94;&#x8FD9;&#x4E24;&#x4E2A;&#x6A21;&#x578B;&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x60C5;&#x51B5;&#x5374;&#x4E0D;&#x662F;&#x8FD9;&#x6837;&#x3002;</p>
<p><img src="images/activerecord/habtm-association-table-name.png" alt="habtm-association-table-name"></p>
<p>ActiveRecord &#x901A;&#x8FC7;&#x8986;&#x5199;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x7684; <code>.table_name</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x7528;&#x4E00;&#x4E2A; <code>JoinTableResolver</code> &#x6765;&#x89E3;&#x51B3;&#x4E0D;&#x540C;&#x7684;&#x6A21;&#x578B;&#x62E5;&#x6709;&#x76F8;&#x540C;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8868;&#x7684;&#x95EE;&#x9898;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Migration</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">JoinTable</span></span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">join_table_name</span><span class="hljs-params">(table_1, table_2)</span></span>
      ModelSchema.derive_join_table_name(table_1, table_2).to_sym
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ModelSchema</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">derive_join_table_name</span><span class="hljs-params">(first_table, second_table)</span></span> 
    [first_table.to_s, second_table.to_s].sort.join(<span class="hljs-string">&quot;\0&quot;</span>).gsub(<span class="hljs-regexp">/^(.*_)(.+)\0\1(.+)/</span>, <span class="hljs-string">&apos;\1\2_\3&apos;</span>).tr(<span class="hljs-string">&quot;\0&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x9ED8;&#x8BA4;&#x7684; <code>join_table</code> &#x89C4;&#x5219;&#x4E2D;&#xFF0C;&#x4E24;&#x5F20;&#x8868;&#x4F1A;&#x6309;&#x7167;&#x5B57;&#x6BCD;&#x987A;&#x5E8F;&#x6392;&#x5E8F;&#xFF0C;&#x6700;&#x540E;&#x901A;&#x8FC7; <code>_</code> &#x8FDE;&#x63A5;&#x5230;&#x4E00;&#x8D77;&#xFF0C;&#x4F46;&#x662F;&#x5982;&#x679C;&#x4E24;&#x5F20;&#x8868;&#x6709;&#x7740;&#x5B8C;&#x5168;&#x76F8;&#x540C;&#x7684;&#x524D;&#x7F00;&#xFF0C;&#x6BD4;&#x5982; music_artists &#x548C; music_records &#x4E24;&#x5F20;&#x8868;&#xFF0C;&#x5B83;&#x4EEC;&#x8FDE;&#x63A5;&#x7684;&#x7ED3;&#x679C;&#x5C31;&#x662F; music_artists_records&#xFF0C;&#x516C;&#x5171;&#x7684;&#x524D;&#x7F00;&#x4F1A;&#x88AB;&#x5220;&#x9664;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x7ECF;&#x5E38;&#x53D1;&#x751F;&#x5728;&#x5305;&#x542B;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x7684;&#x6A21;&#x578B;&#x4E2D;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;<code>Music::Artist</code>&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x901A;&#x8FC7;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x7684; Builder &#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x4E2D;&#x95F4;&#x6A21;&#x578B;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x5EFA;&#x7ACB;&#x4E24;&#x4E2A; <code>Reflection</code> &#x5BF9;&#x8C61;&#xFF1A;</p>
<pre><code class="lang-ruby">habtm_reflection = <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Reflection</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:HasAndBelongsToManyReflection</span>.new(name, scope, options, <span class="hljs-keyword">self</span>)
middle_reflection = builder.middle_reflection join_model
<span class="hljs-symbol">Builder:</span><span class="hljs-symbol">:HasMany</span>.define_callbacks <span class="hljs-keyword">self</span>, middle_reflection
Reflection.add_reflection <span class="hljs-keyword">self</span>, middle_reflection.name, middle_reflection
middle_reflection.parent_reflection = habtm_reflection
</code></pre>
<p>&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x662F; <code>HasAndBelongsToManyReflection</code> &#x5B9E;&#x4F8B;&#xFF0C;&#x8868;&#x793A;&#x5F53;&#x524D;&#x7684;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x662F; <code>#middle_reflection</code> &#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684; <code>HasMany</code>&#xFF0C;&#x8868;&#x793A;&#x5F53;&#x524D;&#x7684;&#x7C7B;&#x4E0E; <code>join_model</code> &#x4E4B;&#x95F4;&#x6709;&#x4E00;&#x4E2A;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x8FD9;&#x4E2A;&#x5173;&#x7CFB;&#x662F;&#x9690;&#x5F0F;&#x7684;&#xFF0C;&#x4E0D;&#x8FC7;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6765;&#x300E;&#x7406;&#x89E3;&#x300F;&#x5B83;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> &lt; ActiveRecord::Base</span>
  <span class="hljs-comment"># has_and_belongs_to_many :posts</span>
  <span class="hljs-comment"># =</span>
  has_many <span class="hljs-symbol">:posts_tag</span>
  <span class="hljs-comment"># + </span>
  <span class="hljs-comment"># ...</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x4E0A;&#x8FF0;&#x7684;&#x4EE3;&#x7801;&#x6784;&#x6210;&#x4E86;&#x6574;&#x4E2A;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x7684;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x800C;&#x53E6;&#x4E00;&#x90E8;&#x5206;&#x7531;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6765;&#x5904;&#x7406;&#xFF0C;&#x5F53;&#x6A21;&#x578B;&#x6301;&#x6709;&#x4E86;&#x4E00;&#x4E2A;&#x8DDF;&#x4E2D;&#x95F4;&#x6A21;&#x578B;&#x76F8;&#x5173;&#x7684;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x521B;&#x5EFA;&#x53E6;&#x4E00;&#x4E2A;&#x4EE5;&#x4E2D;&#x95F4;&#x6A21;&#x578B;&#x4E3A;&#x6865;&#x6881; has_many &#x5173;&#x7CFB;&#xFF1A;</p>
<pre><code class="lang-ruby">hm_options = {}
hm_options[<span class="hljs-symbol">:through</span>] = middle_reflection.name
hm_options[<span class="hljs-symbol">:source</span>] = join_model.right_reflection.name

<span class="hljs-symbol">ActiveSupport:</span><span class="hljs-symbol">:Deprecation</span>.silence { has_many name, scope, hm_options, &amp;extension }
</code></pre>
<p>&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x4F7F;&#x7528; <code>Post</code> &#x548C; <code>Tag</code> &#x8FD9;&#x4E24;&#x4E2A;&#x6A21;&#x578B;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#x4E3E;&#x4F8B;&#x5B50;&#xFF0C;&#x901A;&#x8FC7;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x4E24;&#x4E2A;&#x7C7B;&#x4E2D;&#x5206;&#x522B;&#x5EFA;&#x7ACB;&#x5982;&#x4E0B;&#x7684;&#x5173;&#x7CFB;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> &lt; ActiveRecord::Base</span>
  <span class="hljs-comment"># has_many :posts_tag</span>
  has_many <span class="hljs-symbol">:tags</span>, <span class="hljs-symbol">through:</span> <span class="hljs-symbol">:posts_tag</span>, <span class="hljs-symbol">source:</span> <span class="hljs-symbol">:tag</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tag</span> &lt; ActiveRecord::Base</span>
  <span class="hljs-comment"># has_many :tags_post</span>
  has_many <span class="hljs-symbol">:post</span>, <span class="hljs-symbol">through:</span> <span class="hljs-symbol">:tags_post</span>, <span class="hljs-symbol">source:</span> <span class="hljs-symbol">:post</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x4E24;&#x4E2A;&#x9690;&#x5F0F;&#x7684; has_many &#x5173;&#x7CFB;&#xFF0C;&#x4E24;&#x4E2A;&#x663E;&#x793A;&#x7684; has_many &#x5C31;&#x80FD;&#x591F;&#x901A;&#x8FC7; <code>through</code> &#x548C; <code>source</code> &#x95F4;&#x63A5;&#x627E;&#x5230;&#x81EA;&#x5DF1;&#x5BF9;&#x5E94;&#x7684;&#x591A;&#x4E2A;&#x6570;&#x636E;&#x884C;&#xFF0C;&#x800C;&#x4ECE;&#x5F00;&#x53D1;&#x8005;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x770B;&#xFF0C;&#x6574;&#x4E2A;&#x5DE5;&#x7A0B;&#x4E2D;&#x53EA;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x884C;&#x4EE3;&#x7801; <code>has_and_belongs_to_many :models</code>&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x5DE5;&#x4F5C;&#x5B8C;&#x5168;&#x90FD;&#x662F;&#x9690;&#x5F0F;&#x7684;&#x3002;</p>
<p><img src="images/activerecord/many-to-many-associations.png" alt="many-to-many-associations"></p>
<p>&#x7531;&#x4E8E;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#x5176;&#x5B9E;&#x5E76;&#x6CA1;&#x6709;&#x7269;&#x7406;&#x4E0A;&#x7684;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x903B;&#x8F91;&#x4E0A;&#x624D;&#x80FD;&#x5B9E;&#x73B0;&#x591A;&#x5BF9;&#x591A;&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x6BCF;&#x4E00;&#x4E2A;&#x6A21;&#x578B;&#x6765;&#x8BF4;&#xFF0C;&#x5B83;&#x5B9E;&#x73B0;&#x7684;&#x90FD;&#x662F;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF1B;&#x53EA;&#x6709;&#x4ECE;&#x6574;&#x4F53;&#x6765;&#x770B;&#xFF0C;&#x901A;&#x8FC7; <code>PostsTags</code> &#x7B2C;&#x4E09;&#x5F20;&#x8868;&#x7684;&#x5F15;&#x5165;&#xFF0C;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x7684;&#x624D;&#x662F;&#x4ECE; <code>Post</code> &#x5230; <code>Tag</code> &#x4E4B;&#x95F4;&#x7684;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x3002;</p>
<h3 id="&#x5C0F;&#x7ED3;">&#x5C0F;&#x7ED3;</h3>
<p>ActiveRecord &#x5BF9;&#x5173;&#x7CFB;&#x7684;&#x652F;&#x6301;&#x5176;&#x5B9E;&#x975E;&#x5E38;&#x5168;&#x9762;&#xFF0C;&#x4ECE;&#x6700;&#x5E38;&#x89C1;&#x7684;&#x4E00;&#x5BF9;&#x4E00;&#x3001;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x518D;&#x5230;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x90FD;&#x6709;&#x7740;&#x975E;&#x5E38;&#x4F18;&#x96C5;&#x3001;&#x7B80;&#x6D01;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x867D;&#x7136;&#x8FD9;&#x4E00;&#x5C0F;&#x8282;&#x4E2D;&#x6CA1;&#x80FD;&#x5168;&#x9762;&#x7684;&#x4ECB;&#x7ECD;&#x6240;&#x6709;&#x5173;&#x7CFB;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x6574;&#x4E2A;&#x6A21;&#x5757;&#x4E2D;&#x91CD;&#x8981;&#x7C7B;&#x548C;&#x6574;&#x4F53;&#x67B6;&#x6784;&#x7684;&#x4ECB;&#x7ECD;&#x5DF2;&#x7ECF;&#x975E;&#x5E38;&#x5177;&#x4F53;&#x4E86;&#xFF1B;&#x4E0D;&#x5F97;&#x4E0D;&#x611F;&#x53F9; ActiveRecord &#x5BF9;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x65B9;&#x6CD5; <code>has_and_belongs_to_many</code> &#x7684;&#x5B9E;&#x73B0;&#x975E;&#x5E38;&#x6574;&#x6D01;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x5206;&#x6790;&#x5176;&#x5B9E;&#x73B0;&#x65F6;&#x4E5F;&#x975E;&#x5E38;&#x987A;&#x7545;&#x3002;</p>
<h2 id="migrations-&#x4EFB;&#x52A1;&#x548C;&#x6267;&#x884C;&#x8FC7;&#x7A0B;">Migrations &#x4EFB;&#x52A1;&#x548C;&#x6267;&#x884C;&#x8FC7;&#x7A0B;</h2>
<p>Migrations&#xFF08;&#x8FC1;&#x79FB;&#xFF09;&#x662F; ActiveRecord &#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x79CD;&#x7528;&#x4E8E;&#x66F4;&#x6539;&#x6570;&#x636E;&#x5E93; Schema &#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x64CD;&#x4F5C;&#x6570;&#x636E;&#x5E93;&#x7684; DSL&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x53BB;&#x624B;&#x5199;&#x6240;&#x6709;&#x7684; SQL &#x6765;&#x66F4;&#x65B0;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x8868;&#x7ED3;&#x6784;&#x4E86;&#x3002;</p>
<p><img src="images/activerecord/activerecord-migrations.png" alt="activerecord-migrations"></p>
<p>&#x6BCF;&#x4E00;&#x4E2A; Migration &#x90FD;&#x5177;&#x6709;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;&#x65F6;&#x95F4;&#x6233;&#xFF0C;&#x6BCF;&#x6B21;&#x8FDB;&#x884C;&#x8FC1;&#x79FB;&#x65F6;&#x90FD;&#x4F1A;&#x5728;&#x73B0;&#x6709;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x6267;&#x884C;&#x5F53;&#x524D; Migration &#x6587;&#x4EF6;&#x7684; DSL &#x66F4;&#x65B0;&#x6570;&#x636E;&#x5E93; Schema &#x5F97;&#x5230;&#x65B0;&#x7684;&#x6570;&#x636E;&#x5E93;&#x7248;&#x672C;&#x3002;&#x800C;&#x60F3;&#x8981;&#x7406;&#x89E3; Migrations &#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x77E5;&#x9053; <code>#create_table</code>&#x3001;<code>#add_column</code> &#x7B49; DSL &#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<h3 id="migration51">Migration[5.1]</h3>
<p>&#x6211;&#x5728;&#x4F7F;&#x7528; ActiveRecord &#x63D0;&#x4F9B;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FC1;&#x79FB;&#x7684;&#x65F6;&#x5019;&#x4E00;&#x76F4;&#x90FD;&#x7279;&#x522B;&#x597D;&#x5947; <code>Migration[5.1]</code> &#x540E;&#x9762;&#x8DDF;&#x7740;&#x7684;&#x8FD9;&#x4E2A; <code>[5.1]</code> &#x662F;&#x4E2A;&#x4EC0;&#x4E48;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF0C;&#x770B;&#x4E86;&#x6E90;&#x4EE3;&#x7801;&#x4E4B;&#x540E;&#x6211;&#x624D;&#x77E5;&#x9053;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Migration</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">[]</span><span class="hljs-params">(version)</span></span>
    Compatibility.find(version)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>.[]</code> &#x662F; <code>ActiveRecord::Migration</code> &#x7684;&#x7C7B;&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x901A;&#x8FC7;&#x6267;&#x884C; <code>Compatibility.find</code> &#x6765;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FC1;&#x79FB;&#x7248;&#x672C;&#x662F;&#x5426;&#x4E0E; gem &#x4E2D;&#x7684;&#x7248;&#x672C;&#x517C;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Current</span> &lt; Migration</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>compatibility.rb</code> &#x5728;&#x517C;&#x5BB9;&#x6027;&#x65B9;&#x9762;&#x505A;&#x4E86;&#x5F88;&#x591A;&#x4E8B;&#x60C5;&#xFF0C;&#x4FDD;&#x8BC1; ActiveRecord &#x4E2D;&#x7684;&#x8FC1;&#x79FB;&#x90FD;&#x662F;&#x53EF;&#x4EE5;&#x5411;&#x524D;&#x517C;&#x5BB9;&#x7684;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4E5F;&#x5C31;&#x4E0D;&#x51C6;&#x5907;&#x4ECB;&#x7ECD;&#x592A;&#x591A;&#x4E86;&#x3002;</p>
<h3 id="&#x4ECE;-rake-dbmigrate-&#x5F00;&#x59CB;">&#x4ECE; rake db:migrate &#x5F00;&#x59CB;</h3>
<p>&#x4F5C;&#x8005;&#x5728;&#x9605;&#x8BFB;&#x8FC1;&#x79FB;&#x90E8;&#x5206;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#x65F6;&#x6700;&#x5F00;&#x59CB;&#x4EE5; <code>Migration</code> &#x7C7B;&#x4F5C;&#x4E3A;&#x5165;&#x53E3;&#xFF0C;&#x7ED3;&#x679C;&#x53D1;&#x73B0;&#x8FD9;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x597D;&#x7684;&#x9009;&#x62E9;&#xFF0C;&#x6700;&#x7EC8;&#x4E5F;&#x6CA1;&#x80FD;&#x627E;&#x5230;&#x5B9A;&#x4E49; DSL &#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x6240;&#x4EE5;&#x91CD;&#x65B0;&#x9009;&#x62E9;&#x4E86; <code>rake db:migrate</code> &#x4F5C;&#x4E3A;&#x5165;&#x53E3;&#x5206;&#x6790;&#x8FC1;&#x79FB;&#x7684;&#x5B9E;&#x73B0;&#xFF1B;&#x901A;&#x8FC7;&#x5BF9;&#x5DE5;&#x7A0B;&#x76EE;&#x5F55;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x5F88;&#x5FEB;&#x5C31;&#x80FD;&#x53D1;&#x73B0; ActiveRecord &#x4E2D;&#x6240;&#x6709;&#x7684; rake &#x547D;&#x4EE4;&#x90FD;&#x4F4D;&#x4E8E; <code>lib/railties/database.rake</code> &#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x5728;&#x6587;&#x4EF6;&#x4E2D;&#x4E5F;&#x80FD;&#x627E;&#x5230; <code>db:migrate</code> &#x5BF9;&#x5E94;&#x7684; rake &#x4EFB;&#x52A1;&#xFF1A;</p>
<pre><code class="lang-ruby">db_namespace = namespace <span class="hljs-symbol">:db</span> <span class="hljs-keyword">do</span>
  desc <span class="hljs-string">&quot;Migrate the database (options: VERSION=x, VERBOSE=false, SCOPE=blog).&quot;</span>
  task <span class="hljs-symbol">migrate:</span> [<span class="hljs-symbol">:environment</span>, <span class="hljs-symbol">:load_config</span>] <span class="hljs-keyword">do</span>
    <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Tasks</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:DatabaseTasks</span>.migrate
    db_namespace[<span class="hljs-string">&quot;_dump&quot;</span>].invoke
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x4E2D;&#x7684; <code>DatabaseTasks</code> &#x7C7B;&#x5C31;&#x5305;&#x542B;&#x5728; <code>lib/active_record/tasks</code> &#x76EE;&#x5F55;&#x4E2D;&#x7684; <code>database_tasks.rb</code> &#x6587;&#x4EF6;&#x91CC;&#xFF1A;</p>
<pre><code class="lang-ruby">lib/active_record/tasks/
&#x251C;&#x2500;&#x2500; database_tasks.rb
&#x251C;&#x2500;&#x2500; mysql_database_tasks.rb
&#x251C;&#x2500;&#x2500; postgresql_database_tasks.rb
&#x2514;&#x2500;&#x2500; sqlite_database_tasks.rb
</code></pre>
<p><code>#migrate</code> &#x65B9;&#x6CD5;&#x5C31;&#x662F; <code>DatabaseTasks</code> &#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#x65B9;&#x6CD5;&#xFF0C;&#x540C;&#x65F6; ActiveRecord &#x901A;&#x8FC7; <code>extend self</code> &#x5C06; <code>#migrate</code> &#x65B9;&#x6CD5;&#x6DFB;&#x52A0;&#x5230;&#x4E86;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x5355;&#x7C7B;&#x4E0A;&#xFF0C;&#x6210;&#x4E3A;&#x4E86;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x7C7B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Tasks</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">DatabaseTasks</span></span>
    extend <span class="hljs-keyword">self</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrate</span></span>
      raise <span class="hljs-string">&quot;Empty VERSION provided&quot;</span> <span class="hljs-keyword">if</span> ENV[<span class="hljs-string">&quot;VERSION&quot;</span>] &amp;&amp; ENV[<span class="hljs-string">&quot;VERSION&quot;</span>].empty?

      version = ENV[<span class="hljs-string">&quot;VERSION&quot;</span>] ? ENV[<span class="hljs-string">&quot;VERSION&quot;</span>].to_i <span class="hljs-symbol">:</span> <span class="hljs-keyword">nil</span>
      scope = ENV[<span class="hljs-string">&quot;SCOPE&quot;</span>]
      Migrator.migrate(migrations_paths, version) <span class="hljs-keyword">do</span> |migration|
        scope.blank? || scope == migration.scope
      <span class="hljs-keyword">end</span>
      <span class="hljs-symbol">ActiveRecord:</span><span class="hljs-symbol">:Base</span>.clear_cache!
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4 id="&#x300E;&#x8FC1;&#x79FB;&#x5668;&#x300F;migrator">&#x300E;&#x8FC1;&#x79FB;&#x5668;&#x300F;Migrator</h4>
<p>&#x8FC1;&#x79FB;&#x4EFB;&#x52A1;&#x4E2D;&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x4E86; <code>Migrator.migrate</code> &#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;&#x4F20;&#x5165;&#x8FC1;&#x79FB;&#x6587;&#x4EF6;&#x7684;&#x8DEF;&#x5F84;&#x548C;&#x671F;&#x671B;&#x7684;&#x8FC1;&#x79FB;&#x7248;&#x672C;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x8FDB;&#x884C;&#x8FC1;&#x79FB;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Migrator</span><span class="hljs-comment">#:nodoc:</span></span>
  <span class="hljs-class"><span class="hljs-keyword">class</span> &lt;&lt; self</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrate</span><span class="hljs-params">(migrations_paths, target_version = <span class="hljs-keyword">nil</span>, &amp;block)</span></span>
      <span class="hljs-keyword">case</span>
      <span class="hljs-keyword">when</span> target_version.<span class="hljs-keyword">nil</span>?
        up(migrations_paths, target_version, &amp;block)
      <span class="hljs-keyword">when</span> current_version == <span class="hljs-number">0</span> &amp;&amp; target_version == <span class="hljs-number">0</span>
        []
      <span class="hljs-keyword">when</span> current_version &gt; target_version
        down(migrations_paths, target_version, &amp;block)
      <span class="hljs-keyword">else</span>
        up(migrations_paths, target_version, &amp;block)
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x663E;&#x7136;&#x6211;&#x4EEC;&#x662F;&#x4E0D;&#x4F1A;&#x4F20;&#x5165;&#x76EE;&#x6807;&#x7684;&#x6570;&#x636E;&#x5E93;&#x7248;&#x672C;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; <code>target_version.nil? == true</code>&#xFF0C;&#x8FD9;&#x65F6;&#x4F1A;&#x6267;&#x884C; <code>.up</code> &#x65B9;&#x6CD5;&#xFF0C;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x5411;&#x300E;&#x4E0A;&#x300F;&#x8FC1;&#x79FB;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">up</span><span class="hljs-params">(migrations_paths, target_version = <span class="hljs-keyword">nil</span>)</span></span>
  migrations = migrations(migrations_paths)
  migrations.select! { |m| <span class="hljs-keyword">yield</span> m } <span class="hljs-keyword">if</span> block_given?

  new(<span class="hljs-symbol">:up</span>, migrations, target_version).migrate
<span class="hljs-keyword">end</span>
</code></pre>
<h4 id="&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x6808;">&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x6808;</h4>
<p>&#x901A;&#x8FC7; <code>.new</code> &#x65B9;&#x6CD5; ActiveRecord &#x521D;&#x59CB;&#x5316;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684; <code>Migrator</code> &#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;&#x4E86; <code>Migrator#migrate</code>&#xFF0C;&#x5728;&#x6574;&#x4E2A;&#x8FC1;&#x79FB;&#x6267;&#x884C;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6709;&#x4EE5;&#x4E0B;&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x6808;&#xFF1A;</p>
<p><img src="images/activerecord/rake-db-migrate.png" alt="rake-db-migrate"></p>
<p>&#x5728;&#x6574;&#x4E2A;&#x8FC1;&#x79FB;&#x8FC7;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5173;&#x6CE8;&#x4EE5;&#x4E0B;&#x7684;&#x56DB;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x9996;&#x5148;&#x662F; <code>Migrator#migrate_without_lock</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrate_without_lock</span></span>
  <span class="hljs-keyword">if</span> invalid_target?
    raise UnknownMigrationVersionError.new(@target_version)
  <span class="hljs-keyword">end</span>

  result = runnable.each <span class="hljs-keyword">do</span> |migration|
    execute_migration_in_transaction(migration, @direction)
  <span class="hljs-keyword">end</span>

  record_environment
  result
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5176;&#x5B9E;&#x5E76;&#x6CA1;&#x6709;&#x90A3;&#x4E48;&#x91CD;&#x8981;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x8C03;&#x7528;&#x4E86; <code>Migrator#runnable</code> &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65E0;&#x53C2;&#x7684;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x4E86;&#x6240;&#x6709;&#x9700;&#x8981;&#x8FD0;&#x884C;&#x7684; <code>Migration</code> &#x6587;&#x4EF6;&#xFF0C;<code>Migrator#runnable</code> &#x662F;&#x5982;&#x4F55;&#x9009;&#x62E9;&#x9700;&#x8981;&#x8FC1;&#x79FB;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x4F5C;&#x8005;&#x6BD4;&#x8F83;&#x60F3;&#x8981;&#x4E86;&#x89E3;&#x7684;&#xFF0C;&#x4E5F;&#x662F;&#x4F5C;&#x8005;&#x8BA4;&#x4E3A;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x5730;&#x65B9;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">runnable</span></span>
  runnable = migrations[start..finish]
  <span class="hljs-keyword">if</span> up?
    runnable.reject { |m| ran?(m) }
  <span class="hljs-keyword">else</span>
    runnable.pop <span class="hljs-keyword">if</span> target
    runnable.find_all { |m| ran?(m) }
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ran?</span><span class="hljs-params">(migration)</span></span>
  migrated.<span class="hljs-keyword">include</span>?(migration.version.to_i)
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x5BF9;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x9605;&#x8BFB;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5982;&#x679C;&#x8FC1;&#x79FB;&#x6A21;&#x5F0F;&#x662F; <code>:up</code>&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x9009;&#x62E9;&#x6240;&#x6709;&#x672A;&#x8FC1;&#x79FB;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5728;&#x8FD9;&#x65F6;<strong>&#x8FC1;&#x79FB;&#x6587;&#x4EF6;&#x7684;&#x9009;&#x62E9;&#x4E0E;&#x521B;&#x5EFA;&#x7684;&#x987A;&#x5E8F;&#x662F;&#x65E0;&#x5173;&#x7684;</strong>&#x3002;</p>
<h4 id="&#x8FC1;&#x79FB;&#x7684;&#x6267;&#x884C;">&#x8FC1;&#x79FB;&#x7684;&#x6267;&#x884C;</h4>
<p>&#x5F53;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <code>#runnable</code> &#x83B7;&#x5F97;&#x4E86;&#x6574;&#x4E2A;&#x5F85;&#x8FD0;&#x884C;&#x7684;&#x8FC1;&#x79FB;&#x6587;&#x4EF6;&#x6570;&#x7EC4;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x904D;&#x5386;&#x6240;&#x6709;&#x7684;&#x6587;&#x4EF6;&#x4E00;&#x6B21;&#x6267;&#x884C; <code>Migrator#execute_migrate_in_transaction</code> &#x65B9;&#x6CD5;&#x4E86;&#xFF0C;&#x5728;&#x8C03;&#x7528;&#x6808;&#x7684;&#x6700;&#x540E;&#x4F1A;&#x6267;&#x884C; <code>Migration#exec_migration</code>&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exec_migration</span><span class="hljs-params">(conn, direction)</span></span>
  @connection = conn
  <span class="hljs-keyword">if</span> respond_to?(<span class="hljs-symbol">:change</span>)
    <span class="hljs-keyword">if</span> direction == <span class="hljs-symbol">:down</span>
      revert { change }
    <span class="hljs-keyword">else</span>
      change
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span>
    send(direction)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">ensure</span>
  @connection = <span class="hljs-keyword">nil</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x80FD;&#x4E0E;&#x6211;&#x4EEC;&#x5E73;&#x65F6;&#x5728; <code>Migration</code> &#x4E2D;&#x5B9E;&#x73B0;&#x7684; <code>#change</code>&#x3001;<code>#up</code> &#x548C; <code>#down</code> &#x8FDE;&#x5230;&#x4E00;&#x8D77;&#xFF0C;&#x903B;&#x8F91;&#x4E5F;&#x8D70;&#x901A;&#x4E86;&#xFF1B;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x7684;&#x903B;&#x8F91;&#x8FD8;&#x662F;&#x5F88;&#x6E05;&#x6670;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x7684; <code>Migratoin</code> &#x5B9E;&#x73B0;&#x4E86; <code>#change</code> &#x65B9;&#x6CD5;&#x5C31;&#x4F1A;&#x6839;&#x636E; <code>direction</code> &#x9009;&#x62E9;&#x6267;&#x884C; <code>#change</code> &#x8FD8;&#x662F; <code>#revert + #change</code>&#xFF0C;&#x5426;&#x5219;&#x5C31;&#x4F1A;&#x6309;&#x7167;&#x8FC1;&#x79FB;&#x7684;&#x65B9;&#x5411;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<h3 id="migrations-&#x7684;-dsl">Migrations &#x7684; DSL</h3>
<p>&#x5728;&#x6570;&#x636E;&#x8FC1;&#x79FB;&#x7684;&#x6A21;&#x5757;&#x6267;&#x884C;&#x7684; Migration &#x6587;&#x4EF6;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x90FD;&#x662F; ActiveRecord &#x63D0;&#x4F9B;&#x7684; DSL &#x8BED;&#x6CD5;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x8BED;&#x6CD5;&#x5305;&#x542B;&#x4E24;&#x90E8;&#x5206;&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x662F; Schema &#x76F8;&#x5173;&#x7684; DSL <code>schema_statements.rb</code>&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x62EC;&#x8868;&#x683C;&#x7684;&#x521B;&#x5EFA;&#x548C;&#x5220;&#x9664;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x7528;&#x4E8E;&#x8F85;&#x52A9; Schema &#x521B;&#x5EFA;&#x7684; <code>#column_exists?</code> &#x7B49;&#x65B9;&#x6CD5;&#xFF0C;&#x53E6;&#x4E00;&#x90E8;&#x5206;&#x662F;&#x8868;&#x5B9A;&#x4E49;&#x76F8;&#x5173;&#x7684; DSL <code>schema_definitions.rb</code>&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x62EC;&#x5904;&#x7406;&#x8868;&#x7ED3;&#x6784;&#x7684; <code>TableDefinition</code> &#x7C7B;&#x548C;&#x62BD;&#x8C61;&#x4EE3;&#x8868;&#x4E00;&#x5F20;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x8868;&#x7684; <code>Table</code> &#x7C7B;&#x3002;</p>
<h4 id="&#x62BD;&#x8C61;&#x9002;&#x914D;&#x5668;">&#x62BD;&#x8C61;&#x9002;&#x914D;&#x5668;</h4>
<p>&#x5728;&#x6574;&#x4E2A; <code>connection_adapters</code> &#x7684;&#x5B50;&#x6A21;&#x5757;&#x4E2D;&#xFF0C;&#x7EDD;&#x5927;&#x591A;&#x6570;&#x6A21;&#x5757;&#x5728;&#x4E09;&#x5927; SQL &#x6570;&#x636E;&#x5E93;&#xFF0C;MySQL&#x3001;PostgreSQL &#x548C; sqlite3 &#x4E2D;&#x90FD;&#x6709;&#x7740;&#x5404;&#x81EA;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-ruby">lib/active_record/connection_adapters
&#x251C;&#x2500;&#x2500; abstract
&#x2502;   &#x251C;&#x2500;&#x2500; connection_pool.rb
&#x2502;   &#x251C;&#x2500;&#x2500; database_limits.rb
&#x2502;   &#x251C;&#x2500;&#x2500; database_statements.rb
&#x2502;   &#x251C;&#x2500;&#x2500; query_cache.rb
&#x2502;   &#x251C;&#x2500;&#x2500; quoting.rb
&#x2502;   &#x251C;&#x2500;&#x2500; savepoints.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_creation.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_definitions.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_dumper.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_statements.rb
&#x2502;   &#x2514;&#x2500;&#x2500; transaction.rb
&#x251C;&#x2500;&#x2500; mysql
&#x2502;   &#x251C;&#x2500;&#x2500; column.rb
&#x2502;   &#x251C;&#x2500;&#x2500; database_statements.rb
&#x2502;   &#x251C;&#x2500;&#x2500; explain_pretty_printer.rb
&#x2502;   &#x251C;&#x2500;&#x2500; quoting.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_creation.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_definitions.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_dumper.rb
&#x2502;   &#x251C;&#x2500;&#x2500; schema_statements.rb
&#x2502;   &#x2514;&#x2500;&#x2500; type_metadata.rb
&#x251C;&#x2500;&#x2500; postgresql
&#x2502;   &#x2514;&#x2500;&#x2500; ...
&#x251C;&#x2500;&#x2500; sqlite3
&#x2502;   &#x2514;&#x2500;&#x2500; ...
&#x251C;&#x2500;&#x2500; abstract_adapter.rb
&#x251C;&#x2500;&#x2500; ...
&#x2514;&#x2500;&#x2500; sqlite3_adapter.rb
</code></pre>
<p>&#x4E0D;&#x8FC7;&#x8FD9;&#x4E09;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6240;&#x6709;&#x5B50;&#x6A21;&#x5757;&#x90FD;&#x7EE7;&#x627F;&#x81EA; <code>AbstractAdapter</code> &#x4E0B;&#x9762;&#x5BF9;&#x5E94;&#x7684;&#x5B50;&#x6A21;&#x5757;&#xFF0C;&#x4EE5;&#x83B7;&#x5F97;&#x4E00;&#x4E9B;&#x4E09;&#x8005;&#x5171;&#x7528;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x5305;&#x62EC;&#x6570;&#x636E;&#x5E93;&#x3001;Schema &#x7684;&#x58F0;&#x660E;&#x4E0E;&#x7BA1;&#x7406;&#x7B49;&#x529F;&#x80FD;&#x3002;</p>
<p><img src="images/activerecord/abstract-adapter-and-much-more.png" alt="abstract-adapter-and-much-more"></p>
<p>&#x901A;&#x8FC7; <code>AbstractAdapter</code> &#x62BD;&#x79BB;&#x51FA;&#x7684;&#x516C;&#x7528;&#x529F;&#x80FD;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x65B0;&#x7684;&#x9002;&#x914D;&#x5668;&#x968F;&#x65F6;&#x9002;&#x914D;&#x5176;&#x4ED6;&#x7684; SQL &#x6570;&#x636E;&#x5E93;&#x3002;</p>
<h4 id="schema-dsl">Schema DSL</h4>
<p>&#x6570;&#x636E;&#x5E93;&#x7684; Schema DSL &#x90E8;&#x5206;&#x5C31;&#x5305;&#x542B;&#x6211;&#x4EEC;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x7684; <code>#create_table</code>&#x3001;<code>#rename_table</code> &#x4EE5;&#x53CA; <code>#add_column</code> &#x8FD9;&#x4E9B;&#x9700;&#x8981;&#x8868;&#x540D;&#x624D;&#x80FD;&#x6267;&#x884C;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4EE5;&#x6700;&#x5E38;&#x89C1;&#x7684; <code>#create_table</code> &#x4E3A;&#x4F8B;&#xFF0C;&#x7B80;&#x5355;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x8FD9;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_table</span><span class="hljs-params">(table_name, <span class="hljs-symbol">comment:</span> <span class="hljs-keyword">nil</span>, **options)</span></span>
  td = create_table_definition table_name, options[<span class="hljs-symbol">:temporary</span>], options[<span class="hljs-symbol">:options</span>], options[<span class="hljs-symbol">:as</span>], <span class="hljs-symbol">comment:</span> comment

  <span class="hljs-keyword">yield</span> td <span class="hljs-keyword">if</span> block_given?

  execute schema_creation.accept td
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x9996;&#x5148;&#xFF0C;&#x5728;&#x521B;&#x5EFA;&#x8868;&#x65F6;&#x5148;&#x901A;&#x8FC7; <code>#create_table_definition</code> &#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684; <code>TableDefinition</code> &#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x8FD9;&#x4E2A;&#x5B9E;&#x4F8B;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x5165; block&#xFF1A;</p>
<pre><code class="lang-ruby">create_table <span class="hljs-symbol">:users</span> <span class="hljs-keyword">do</span> |t|
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5728; block &#x5BF9;&#x8FD9;&#x4E2A; <code>TableDefinition</code> &#x5BF9;&#x8C61;&#x4E00;&#x987F;&#x64CD;&#x4F5C;&#x540E;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7; <code>SchemaCreation#accept</code> &#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x80FD;&#x591F;&#x521B;&#x5EFA;&#x8868;&#x7684; SQL &#x8BED;&#x53E5;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">accept</span><span class="hljs-params">(o)</span></span>
  m = @cache[o.<span class="hljs-keyword">class</span>] ||= <span class="hljs-string">&quot;visit_<span class="hljs-subst">#{o.<span class="hljs-keyword">class</span>.name.split(<span class="hljs-string">&apos;::&apos;</span>).last}</span>&quot;</span>
  send m, o
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visit_TableDefinition</span><span class="hljs-params">(o)</span></span>
  create_sql = <span class="hljs-string">&quot;CREATE<span class="hljs-subst">#{<span class="hljs-string">&apos; TEMPORARY&apos;</span> <span class="hljs-keyword">if</span> o.temporary}</span> TABLE <span class="hljs-subst">#{quote_table_name(o.name)}</span> &quot;</span>

  statements = o.columns.map { |c| accept c }
  statements &lt;&lt; accept(o.primary_keys) <span class="hljs-keyword">if</span> o.primary_keys

  create_sql &lt;&lt; <span class="hljs-string">&quot;(<span class="hljs-subst">#{statements.join(<span class="hljs-string">&apos;, &apos;</span>)}</span>)&quot;</span> <span class="hljs-keyword">if</span> statements.present?
  add_table_options!(create_sql, table_options(o))
  create_sql &lt;&lt; <span class="hljs-string">&quot; AS <span class="hljs-subst">#{@conn.to_sql(o.as)}</span>&quot;</span> <span class="hljs-keyword">if</span> o.as
  create_sql
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>SchemaCreation</code> &#x7C7B;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x63A5;&#x53D7;&#x5404;&#x79CD;&#x5404;&#x6837;&#x7684; <code>TableDefinition</code>&#x3001;<code>PrimaryKeyDefinition</code> &#x5BF9;&#x8C61;&#x8FD4;&#x56DE; SQL &#x7684;&#x4E00;&#x4E2A;&#x5DE5;&#x5177;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06; <code>SchemaCreation</code> &#x7406;&#x89E3;&#x4E3A;&#x4E00;&#x4E2A;&#x8868;&#x7ED3;&#x6784;&#x7684;&#x89E3;&#x91CA;&#x5668;&#xFF1B;&#x6700;&#x540E;&#x7684; <code>#execute</code> &#x4F1A;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x6267;&#x884C; SQL &#x6539;&#x53D8;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x8868;&#x7ED3;&#x6784;&#x3002;</p>
<p>&#x5728; <code>SchemaStatements</code> &#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x5176;&#x5B83;&#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x90FD;&#x662F;&#x5927;&#x540C;&#x5C0F;&#x5F02;&#xFF0C;&#x6BD4;&#x5982; <code>#drop_table</code> &#x5176;&#x5B9E;&#x90FD;&#x662F;&#x5220;&#x9664;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x67D0;&#x5F20;&#x8868;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">drop_table</span><span class="hljs-params">(table_name, options = {})</span></span>
  execute <span class="hljs-string">&quot;DROP TABLE<span class="hljs-subst">#{<span class="hljs-string">&apos; IF EXISTS&apos;</span> <span class="hljs-keyword">if</span> options[<span class="hljs-symbol">:if_exists</span>]}</span> <span class="hljs-subst">#{quote_table_name(table_name)}</span>&quot;</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4 id="&#x8868;&#x5B9A;&#x4E49;-dsl">&#x8868;&#x5B9A;&#x4E49; DSL</h4>
<p><code>SchemaStatements</code> &#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53C2;&#x6570;&#x5927;&#x90FD;&#x5305;&#x542B; <code>table_name</code>&#xFF0C;&#x800C;&#x53E6;&#x4E00;&#x4E2A;&#x7C7B; <code>TableDefinitions</code> &#x5C31;&#x5305;&#x542B;&#x4E86;&#x76F4;&#x63A5;&#x5BF9;&#x8868;&#x64CD;&#x4F5C;&#x7684; DSL&#xFF1A;</p>
<pre><code class="lang-ruby">create_table <span class="hljs-symbol">:foo</span> <span class="hljs-keyword">do</span> |t|
  puts t.<span class="hljs-keyword">class</span>  <span class="hljs-comment"># =&gt; &quot;ActiveRecord::ConnectionAdapters::TableDefinition&quot;</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x5F53;&#x6211;&#x4EEC;&#x5728; <code>#create_table</code> &#x4E2D;&#x4F7F;&#x7528;&#x4F8B;&#x5982; <code>#string</code>&#x3001;<code>#integer</code> &#x7B49;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x4F1A;&#x901A;&#x8FC7;&#x5143;&#x7F16;&#x7A0B;&#x7684;&#x9B54;&#x6CD5;&#x6700;&#x7EC8;&#x6267;&#x884C; <code>TableDefinition#column</code> &#x6539;&#x53D8;&#x8868;&#x7684;&#x5B9A;&#x4E49;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ColumnMethods</span></span>
  [
    <span class="hljs-symbol">:bigint</span>,
    <span class="hljs-comment"># ...</span>
    <span class="hljs-symbol">:integer</span>,
    <span class="hljs-symbol">:string</span>,
    <span class="hljs-symbol">:text</span>,
    <span class="hljs-symbol">:time</span>,
    <span class="hljs-symbol">:timestamp</span>,
    <span class="hljs-symbol">:virtual</span>,
  ].each <span class="hljs-keyword">do</span> |column_type|
    module_eval &lt;&lt;-CODE, __FILE_<span class="hljs-number">_</span>, __LINE_<span class="hljs-number">_</span> + <span class="hljs-number">1</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-comment">#{column_type}(*args, **options)</span></span>
        args.each { |name| column(name, <span class="hljs-symbol">:</span><span class="hljs-comment">#{column_type}, options) }</span>
      <span class="hljs-keyword">end</span>
    CODE
  <span class="hljs-keyword">end</span>
  alias_method <span class="hljs-symbol">:numeric</span>, <span class="hljs-symbol">:decimal</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>#column</code> &#x65B9;&#x6CD5;&#x975E;&#x5E38;&#x795E;&#x5947;&#xFF0C;&#x5B83;&#x4ECE;&#x5404;&#x5904;&#x6536;&#x96C6;&#x6709;&#x5173;&#x5F53;&#x524D;&#x8868;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x6700;&#x7EC8;&#x4E3A;&#x8868;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x5B57;&#x6BB5;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; <code>ColumnDefinition</code> &#x5B9E;&#x4F8B;&#xFF0C;&#x5E76;&#x5B58;&#x50A8;&#x5230;&#x81EA;&#x5DF1;&#x6301;&#x6709;&#x7684; <code>@columns_hash</code> &#x4E2D;&#xFF1A;</p>
<pre><code class="lang-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">column</span><span class="hljs-params">(name, type, options = {})</span></span>
  name = name.to_s
  type = type.to_sym <span class="hljs-keyword">if</span> type
  options = options.dup

  index_options = options.delete(<span class="hljs-symbol">:index</span>)
  index(name, index_options.is_a?(Hash) ? index_options <span class="hljs-symbol">:</span> {}) <span class="hljs-keyword">if</span> index_options
  @columns_hash[name] = new_column_definition(name, type, options)
  <span class="hljs-keyword">self</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new_column_definition</span><span class="hljs-params">(name, type, **options)</span></span>
  type = aliased_types(type.to_s, type)
  options[<span class="hljs-symbol">:primary_key</span>] ||= type == <span class="hljs-symbol">:primary_key</span>
  options[<span class="hljs-symbol">:null</span>] = <span class="hljs-keyword">false</span> <span class="hljs-keyword">if</span> options[<span class="hljs-symbol">:primary_key</span>]
  create_column_definition(name, type, options)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_column_definition</span><span class="hljs-params">(name, type, options)</span></span>
  ColumnDefinition.new(name, type, options)
<span class="hljs-keyword">end</span>
</code></pre>
<p>&#x9664;&#x4E86; <code>ColumnDefinition</code> &#x4E4B;&#x5916;&#xFF0C;&#x5728; ActiveRecord &#x4E2D;&#x8FD8;&#x5B58;&#x5728; <code>PrimaryKeyDefinition</code>&#x3001;<code>IndexDefinition</code> &#x7B49;&#x7B49;&#x7C7B;&#x548C;&#x7ED3;&#x6784;&#x4F53;&#x7528;&#x4E8E;&#x8868;&#x793A;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x67D0;&#x4E00;&#x79CD;&#x5143;&#x7D20;&#x3002;</p>
<p>&#x8868;&#x7ED3;&#x6784;&#x5728;&#x6700;&#x540E;&#x4F1A;&#x88AB; <code>SchemaCreation</code> &#x7C7B;&#x7684; <code>#accept</code> &#x65B9;&#x6CD5;&#x5C55;&#x5F00;&#xFF0C;&#x6700;&#x540E;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x6267;&#x884C;&#x3002;</p>
<h3 id="&#x5C0F;&#x7ED3;">&#x5C0F;&#x7ED3;</h3>
<p>&#x5230;&#x8FD9;&#x91CC;&#x6574;&#x4E2A; Migrations &#x90E8;&#x5206;&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x5DF2;&#x7ECF;&#x9605;&#x8BFB;&#x5206;&#x6790;&#x5B8C;&#x4E86;&#xFF0C;&#x6574;&#x4E2A;&#x300E;&#x6A21;&#x5757;&#x300F;&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x662F; rake &#x4EFB;&#x52A1;&#x6267;&#x884C; DSL &#x4EE3;&#x7801;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x53E6;&#x4E00;&#x90E8;&#x5206;&#x662F; DSL &#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4E24;&#x90E8;&#x5206;&#x7684;&#x7ED3;&#x5408;&#x6700;&#x7EC8;&#x6784;&#x6210;&#x4E86;&#x6574;&#x4E2A; Migrations &#x6A21;&#x5757;&#x7684;&#x5168;&#x90E8;&#x5185;&#x5BB9;&#x3002;</p>
<p>ActiveRecord &#x5BF9;&#x4E8E; Migration &#x8FC1;&#x79FB;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x786E;&#x5B9E;&#x5F88;&#x597D;&#x7684;&#x89E3;&#x51B3;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x8868;&#x7ED3;&#x6784;&#x4E0D;&#x65AD;&#x53D8;&#x66F4;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x540C;&#x65F6;&#x56E0;&#x4E3A;&#x6240;&#x6709;&#x7684; Migration &#x6587;&#x4EF6;&#x90FD;&#x5728;&#x7248;&#x672C;&#x63A7;&#x5236;&#x4E2D;&#x7BA1;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x80FD;&#x591F;&#x968F;&#x65F6;&#x8FD8;&#x539F;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x8868;&#x7ED3;&#x6784;&#x3002;</p>
<h2 id="&#x603B;&#x7ED3;">&#x603B;&#x7ED3;</h2>
<p>&#x6587;&#x7AE0;&#x5BF9; ActiveRecord &#x4E2D;&#x6D89;&#x53CA;&#x7684;&#x5F88;&#x591A;&#x95EE;&#x9898;&#x90FD;&#x8FDB;&#x884C;&#x4E86;&#x5206;&#x6790;&#x548C;&#x4ECB;&#x7ECD;&#xFF0C;&#x5305;&#x62EC;&#x6A21;&#x578B;&#x7684;&#x521B;&#x5EFA;&#x3001;&#x67E5;&#x8BE2;&#x4EE5;&#x53CA;&#x5173;&#x7CFB;&#xFF0C;&#x8FD8;&#x5305;&#x62EC;&#x6570;&#x636E;&#x5E93;&#x8868;&#x8FC1;&#x79FB;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x672C;&#x6765;&#x60F3;&#x5C06;&#x6587;&#x4E2D;&#x7684;&#x51E0;&#x4E2A;&#x90E8;&#x5206;&#x5206;&#x5F00;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;&#xFF0C;&#x4F46;&#x662F;&#x5199;&#x7740;&#x5199;&#x7740;&#x5C31;&#x61D2;&#x5F97;&#x5206;&#x5F00;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x5BF9;&#x6587;&#x7AE0;&#x7684;&#x5185;&#x5BB9;&#x6709;&#x7591;&#x95EE;&#xFF0C;&#x8BF7;&#x5728;&#x535A;&#x5BA2;&#x4E0B;&#x9762;&#x7684; Disqus &#x8BC4;&#x8BBA;&#x7CFB;&#x7EDF;&#x4E2D;&#x7559;&#x8A00;&#xFF0C;&#x9700;&#x8981;&#x7FFB;&#x5899;&#x3002;</p>
<blockquote>
<p>&#x539F;&#x6587;&#x94FE;&#x63A5;&#xFF1A;<a href="https://draveness.me/activerecord.html" target="_blank">&#x7406;&#x89E3; ActiveRecord</a></p>
<p>Follow: <a href="https://github.com/Draveness" target="_blank">Draveness &#xB7; GitHub</a></p>
</blockquote>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../rack/rack-webrik.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: WEBrick 的实现">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Rails","level":"1.1.5.21","depth":3,"next":{"title":"ReactiveObjC","level":"1.1.5.22","depth":3,"ref":"","articles":[{"title":"RACChannel","level":"1.1.5.22.1","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACChannel.md","ref":"Source-Code-Analysis/ReactiveObjC/RACChannel.md","articles":[]},{"title":"RACCommand","level":"1.1.5.22.2","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACCommand.md","ref":"Source-Code-Analysis/ReactiveObjC/RACCommand.md","articles":[]},{"title":"RACDelegateProxy","level":"1.1.5.22.3","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACDelegateProxy.md","ref":"Source-Code-Analysis/ReactiveObjC/RACDelegateProxy.md","articles":[]},{"title":"RACMulticastConnection","level":"1.1.5.22.4","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACMulticastConnection.md","ref":"Source-Code-Analysis/ReactiveObjC/RACMulticastConnection.md","articles":[]},{"title":"RACScheduler","level":"1.1.5.22.5","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACScheduler.md","ref":"Source-Code-Analysis/ReactiveObjC/RACScheduler.md","articles":[]},{"title":"RACSequence","level":"1.1.5.22.6","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACSequence.md","ref":"Source-Code-Analysis/ReactiveObjC/RACSequence.md","articles":[]},{"title":"RACSignal","level":"1.1.5.22.7","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACSignal.md","ref":"Source-Code-Analysis/ReactiveObjC/RACSignal.md","articles":[]},{"title":"RACSubject","level":"1.1.5.22.8","depth":4,"path":"Source-Code-Analysis/ReactiveObjC/RACSubject.md","ref":"Source-Code-Analysis/ReactiveObjC/RACSubject.md","articles":[]}]},"previous":{"title":"WEBrick 的实现","level":"1.1.5.20.3","depth":4,"path":"Source-Code-Analysis/rack/rack-webrik.md","ref":"Source-Code-Analysis/rack/rack-webrik.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Source-Code-Analysis/Rails/activerecord.md","mtime":"2018-05-22T14:51:32.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-04-23T11:29:51.711Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

